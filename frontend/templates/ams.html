{% extends "layout.html" %}
{% set page_title = "AMS √úbersicht" %}
{% set page_subtitle = "Live-Monitoring der Automatic Material System Einheiten" %}

{% block extra_styles %}
<link rel="stylesheet" href="{{ url_for('frontend_static', path='ams.css') }}">
{% endblock %}

{% block content %}

<!-- Loading Overlay -->
<div id="loadingOverlay" class="loading-overlay" style="display: none;">
    <div class="loading-spinner"></div>
    <p>Lade AMS-Daten...</p>
</div>

<!-- AMS Status Cards -->
<section class="ams-stats">
    <div class="stat-card">
        <div class="stat-icon">üéØ</div>
        <div class="stat-content">
            <div class="stat-label">Online AMS</div>
            <div class="stat-value" id="amsOnlineCount">0</div>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon">üßµ</div>
        <div class="stat-content">
            <div class="stat-label">Aktive Slots</div>
            <div class="stat-value" id="amsActiveSlots">0</div>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon">üì¶</div>
        <div class="stat-content">
            <div class="stat-label">Verf√ºgbares Filament</div>
            <div class="stat-value" id="amsAvailableFilament">0kg</div>
        </div>
    </div>
    
    <div class="stat-card stat-card-alerts">
        <div class="stat-icon">‚ö†Ô∏è</div>
        <div class="stat-content">
            <div class="stat-label">Warnungen</div>
            <div class="stat-value" id="amsWarningCount">0</div>
        </div>
    </div>
</section>

<!-- AMS Units Grid -->
<section class="ams-grid">
    <!-- AMS Unit 1 -->
    <div class="ams-unit" data-ams="1">
        <div class="ams-header">
            <div class="ams-title">
                <span class="ams-icon">üé∞</span>
                <div>
                    <h3>AMS #1</h3>
                    <div class="ams-meta">
                        <span class="ams-serial" id="amsSerial1">SN: ‚Äì</span>
                    </div>
                </div>
            </div>
            <div class="ams-status-group">
                <div class="ams-status" id="amsStatus1">
                    <span class="status-badge status-offline">Offline</span>
                </div>
                <div class="ams-printer" id="amsPrinter1">
                    <span class="printer-badge">Kein Drucker</span>
                </div>
            </div>
        </div>
        
        <div class="ams-slots" id="amsSlots1">
            <!-- Slots werden von JavaScript gef√ºllt -->
            <div class="slot-empty">
                <div class="slot-number">Slot 1</div>
                <div class="slot-label">Leer</div>
            </div>
            <div class="slot-empty">
                <div class="slot-number">Slot 2</div>
                <div class="slot-label">Leer</div>
            </div>
            <div class="slot-empty">
                <div class="slot-number">Slot 3</div>
                <div class="slot-label">Leer</div>
            </div>
            <div class="slot-empty">
                <div class="slot-number">Slot 4</div>
                <div class="slot-label">Leer</div>
            </div>
        </div>
    </div>
    
    <!-- AMS Unit 2 -->
    <div class="ams-unit" data-ams="2">
        <div class="ams-header">
            <div class="ams-title">
                <span class="ams-icon">üé∞</span>
                <div>
                    <h3>AMS #2</h3>
                    <div class="ams-meta">
                        <span class="ams-serial" id="amsSerial2">SN: ‚Äì</span>
                    </div>
                </div>
            </div>
            <div class="ams-status-group">
                <div class="ams-status" id="amsStatus2">
                    <span class="status-badge status-offline">Offline</span>
                </div>
                <div class="ams-printer" id="amsPrinter2">
                    <span class="printer-badge">Kein Drucker</span>
                </div>
            </div>
        </div>
        
        <div class="ams-slots" id="amsSlots2">
            <div class="slot-empty">
                <div class="slot-number">Slot 1</div>
                <div class="slot-label">Leer</div>
            </div>
            <div class="slot-empty">
                <div class="slot-number">Slot 2</div>
                <div class="slot-label">Leer</div>
            </div>
            <div class="slot-empty">
                <div class="slot-number">Slot 3</div>
                <div class="slot-label">Leer</div>
            </div>
            <div class="slot-empty">
                <div class="slot-number">Slot 4</div>
                <div class="slot-label">Leer</div>
            </div>
        </div>
    </div>
    
    <!-- AMS Unit 3 -->
    <div class="ams-unit" data-ams="3">
        <div class="ams-header">
            <div class="ams-title">
                <span class="ams-icon">üé∞</span>
                <div>
                    <h3>AMS #3</h3>
                    <div class="ams-meta">
                        <span class="ams-serial" id="amsSerial3">SN: ‚Äì</span>
                    </div>
                </div>
            </div>
            <div class="ams-status-group">
                <div class="ams-status" id="amsStatus3">
                    <span class="status-badge status-offline">Offline</span>
                </div>
                <div class="ams-printer" id="amsPrinter3">
                    <span class="printer-badge">Kein Drucker</span>
                </div>
            </div>
        </div>
        
        <div class="ams-slots" id="amsSlots3">
            <div class="slot-empty">
                <div class="slot-number">Slot 1</div>
                <div class="slot-label">Leer</div>
            </div>
            <div class="slot-empty">
                <div class="slot-number">Slot 2</div>
                <div class="slot-label">Leer</div>
            </div>
            <div class="slot-empty">
                <div class="slot-number">Slot 3</div>
                <div class="slot-label">Leer</div>
            </div>
            <div class="slot-empty">
                <div class="slot-number">Slot 4</div>
                <div class="slot-label">Leer</div>
            </div>
        </div>
    </div>
    
    <!-- AMS Unit 4 -->
    <div class="ams-unit" data-ams="4">
        <div class="ams-header">
            <div class="ams-title">
                <span class="ams-icon">üé∞</span>
                <div>
                    <h3>AMS #4</h3>
                    <div class="ams-meta">
                        <span class="ams-serial" id="amsSerial4">SN: ‚Äì</span>
                    </div>
                </div>
            </div>
            <div class="ams-status-group">
                <div class="ams-status" id="amsStatus4">
                    <span class="status-badge status-offline">Offline</span>
                </div>
                <div class="ams-printer" id="amsPrinter4">
                    <span class="printer-badge">Kein Drucker</span>
                </div>
            </div>
        </div>
        
        <div class="ams-slots" id="amsSlots4">
            <div class="slot-empty">
                <div class="slot-number">Slot 1</div>
                <div class="slot-label">Leer</div>
            </div>
            <div class="slot-empty">
                <div class="slot-number">Slot 2</div>
                <div class="slot-label">Leer</div>
            </div>
            <div class="slot-empty">
                <div class="slot-number">Slot 3</div>
                <div class="slot-label">Leer</div>
            </div>
            <div class="slot-empty">
                <div class="slot-number">Slot 4</div>
                <div class="slot-label">Leer</div>
            </div>
        </div>
    </div>
</section>

<!-- Notification Toast -->
<div id="notification" class="notification"></div>

<!-- Quick-Assign Modal -->
<div id="assignModal" class="modal">
    <div class="modal-content" style="max-width: 650px;">
        <div class="modal-header">
            <h2 id="assignModalTitle">Spule zuweisen</h2>
            <button class="modal-close" onclick="closeAssignModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="spoolSearch" style="font-weight: 600; margin-bottom: 8px; display: block; color: var(--text);">
                    Spule suchen
                </label>
                <input
                    type="text"
                    id="spoolSearch"
                    class="form-control"
                    placeholder="Nummer (#5) oder Name eingeben..."
                    autofocus
                    style="font-size: 1rem; padding: 12px; background: var(--panel-2); border: 2px solid var(--border); color: var(--text);">
                <small style="color: var(--text-dim); font-size: 0.875rem; margin-top: 6px; display: block;">
                    üí° Suche nach Nummer, Name, Hersteller oder Farbe
                </small>
            </div>

            <div id="spoolSearchResults" style="margin-top: 20px; max-height: 450px; overflow-y: auto;">
                <!-- Wird dynamisch gef√ºllt -->
            </div>
        </div>
    </div>
</div>

<!-- Confirm Unassign Modal -->
<div id="confirmUnassignModal" class="modal">
    <div class="modal-content" style="max-width: 450px;">
        <div class="modal-header">
            <h2>Spule entfernen?</h2>
            <button class="modal-close" onclick="closeConfirmUnassignModal()">&times;</button>
        </div>
        <div class="modal-body">
            <p style="margin: 0; color: var(--text); font-size: 1rem;">
                M√∂chtest du die Spule <strong id="confirmSpoolName">wirklich aus dem Slot entfernen</strong>?
            </p>
            <p style="margin: 12px 0 0 0; color: var(--text-dim); font-size: 0.9rem;">
                Die Spule wird wieder als verf√ºgbar markiert.
            </p>
        </div>
        <div style="padding: 0 24px 24px 24px; display: flex; gap: 12px; justify-content: flex-end;">
            <button onclick="closeConfirmUnassignModal()" class="btn" style="background: var(--panel-2); color: var(--text);">
                Abbrechen
            </button>
            <button onclick="confirmUnassignSpool()" class="btn btn-danger" style="background: var(--error); color: white;">
                Entfernen
            </button>
        </div>
    </div>
</div>

<!-- AMS Conflict Modal -->
<div id="amsConflictModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width:520px;">
        <div class="modal-header">
            <h2 id="ams-conflict-title">AMS Konflikt</h2>
            <button class="modal-close" onclick="closeAmsConflictModal()">&times;</button>
        </div>
        <div class="modal-body">
            <p id="ams-conflict-text">Im AMS wurde eine neue Spule mit RFID erkannt. Der Slot ist aktuell manuell belegt.</p>
        </div>
        <div style="padding: 0 24px 24px 24px; display: flex; gap: 12px; justify-content: flex-end;">
            <button id="ams-conflict-cancel-btn" class="btn" onclick="onAmsConflictCancel()">Abbrechen</button>
            <button id="ams-conflict-confirm-btn" class="btn" style="background:var(--accent); color:white;" onclick="onAmsConflictConfirm()">RFID-Spule √ºbernehmen</button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script src="{{ url_for('frontend_static', path='ams.js') }}"></script>
<script src="{{ url_for('frontend_static', path='ams_conflict.js') }}"></script>
{% endblock %}
