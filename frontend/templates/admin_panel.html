<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FilamentHub Admin</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/frontend/admin_panel.css">
</head>
<body>
<script>
// Automatischer Logout bei Reload (serverseitig, da HttpOnly-Cookie)
try {
    const nav = performance.getEntriesByType && performance.getEntriesByType('navigation')[0];
    if (nav && nav.type === 'reload') {
        fetch('/api/admin/logout', { method: 'POST' }).finally(() => {
            window.location.href = '/admin';
        });
    }
} catch {}
</script>
<div class="admin-wrapper">
    <aside class="admin-sidebar">
        <div class="brand">
            <img src="/frontend/static/logo.svg" alt="FilamentHub" class="brand-logo">
            <div class="brand-copy">
                <span class="brand-name">FilamentHub</span>
                <span class="brand-tag">Admin Console</span>
            </div>
        </div>
        <div class="sidebar-group">
            <div class="sidebar-label">ADMIN</div>
            <button class="nav-btn active" onclick="openAdminModal('modal-migrations')">
                <svg width="22" height="22" fill="none" stroke="#ffb300" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 8v4l3 2"/></svg>
                Migration
            </button>
            <button class="nav-btn" onclick="openAdminModal('modal-delete')">
                <svg width="22" height="22" fill="none" stroke="#e53935" stroke-width="2" viewBox="0 0 24 24"><rect x="5" y="11" width="14" height="8" rx="2"/><path d="M9 11V7a3 3 0 0 1 6 0v4"/></svg>
                Eintrag l√∂schen
            </button>
            <button class="nav-btn" onclick="openAdminModal('modal-welcome')">
                <svg width="22" height="22" fill="none" stroke="#4fc3f7" stroke-width="2" viewBox="0 0 24 24"><path d="M12 19V5"/><path d="M5 12h14"/></svg>
                Begr√º√üungstext
            </button>
            <button class="nav-btn" onclick="openAdminModal('modal-db')">
                <svg width="22" height="22" fill="none" stroke="#8ecaff" stroke-width="2" viewBox="0 0 24 24"><ellipse cx="12" cy="6" rx="8" ry="3"/><path d="M4 6v6c0 1.7 3.6 3 8 3s8-1.3 8-3V6"/><path d="M4 12v6c0 1.7 3.6 3 8 3s8-1.3 8-3v-6"/></svg>
                DB-Editor
            </button>
            <button class="nav-btn" onclick="openAdminModal('modal-tables')">
                <svg width="22" height="22" fill="none" stroke="#4caf50" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="9"/></svg>
                Tabellen
            </button>
            <button class="nav-btn" onclick="document.getElementById('admin-notifications').scrollIntoView({behavior:'smooth'})">
                <svg width="22" height="22" fill="none" stroke="#ffc107" stroke-width="2" viewBox="0 0 24 24"><path d="M18 8a6 6 0 1 0-12 0c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
                Benachrichtigungen
            </button>
            <button class="nav-btn" onclick="openAdminModal('modal-debug-settings')">
                <svg width="22" height="22" fill="none" stroke="#9c27b0" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M12 1v6m0 6v6M5.64 5.64l4.24 4.24m6.36 6.36l4.24 4.24M1 12h6m6 0h6M5.64 18.36l4.24-4.24m6.36-6.36l4.24-4.24"/></svg>
                Debug-Einstellungen
            </button>
        </div>
        <div class="sidebar-group" style="margin-top:2rem;">
            <div class="sidebar-label">SYSTEM</div>
            <button class="nav-btn" onclick="logout()">
                <svg width="22" height="22" fill="none" stroke="#fff" stroke-width="2" viewBox="0 0 24 24"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" y1="12" x2="3" y2="12"/></svg>
                Logout
            </button>
        </div>
    </aside>
    <main class="admin-content">
        <div class="hero">
            <div class="hero-text">
                <p class="eyebrow">‚ö° Systemsteuerung</p>
                <h1>Admin Panel</h1>
                <p class="lead">Migrationen ausf√ºhren, Datenbank pflegen, Begr√º√üungen anpassen und Coverage direkt im Browser.</p>
                <div class="hero-pills">
                    <span class="pill">üîí Sicher ‚Ä¢ Auth-required</span>
                    <span class="pill">üõ†Ô∏è Server-Tools</span>
                    <span class="pill">üìä Live-Status</span>
                </div>
            </div>
            <div class="hero-actions">
                <button class="btn-ghost" onclick="openAdminModal('modal-migrations')">üöÄ Migration</button>
                <button class="btn-ghost" onclick="openAdminModal('modal-db')">üíæ DB-Editor</button>
                <button class="btn-ghost" onclick="openAdminModal('modal-coverage')">üìà Coverage</button>
            </div>
        </div>

        <div class="quick-grid">
            <div class="quick-card">
                <div class="quick-label">Migration</div>
                <div class="quick-value">Alembic</div>
                <div class="quick-meta">Upgrade Head & Logs</div>
                <button class="btn-ghost" onclick="openAdminModal('modal-migrations')">√ñffnen</button>
            </div>
            <div class="quick-card">
                <div class="quick-label">Datenbank</div>
                <div class="quick-value">SQL Editor</div>
                <div class="quick-meta">INSERT ¬∑ UPDATE ¬∑ DELETE</div>
                <button class="btn-ghost" onclick="openAdminModal('modal-db')">√ñffnen</button>
            </div>
            <div class="quick-card">
                <div class="quick-label">Coverage</div>
                <div class="quick-value">QA</div>
                <div class="quick-meta">Run & Report</div>
                <button class="btn-ghost" onclick="openAdminModal('modal-coverage')">√ñffnen</button>
            </div>
            <div class="quick-card">
                <div class="quick-label">Willkommen</div>
                <div class="quick-value">Popup</div>
                <div class="quick-meta">Texte & Trigger</div>
                <button class="btn-ghost" onclick="openAdminModal('modal-welcome')">√ñffnen</button>
            </div>
            <div class="quick-card">
                <div class="quick-label">Datenbank</div>
                <div class="quick-value">Tables</div>
                <div class="quick-meta">Schema & Preview</div>
                <button class="btn-ghost" onclick="openAdminModal('modal-tables')">√ñffnen</button>
            </div>
        </div>



        <!-- MODALS -->
        <div id="modal-migrations" class="admin-modal">
            <div class="modal-overlay" onclick="closeAdminModal('modal-migrations')"></div>
            <div class="modal-box">
                <div class="modal-header">
                    <h2>‚è±Ô∏è Migrations</h2>
                    <button class="modal-close" onclick="closeAdminModal('modal-migrations')">‚úï</button>
                </div>
                <div class="modal-body">
                    <div class="note">Alembic upgrade head ausf√ºhren</div>
                    <button id="migrateBtn">üöÄ MIGRATION STARTEN</button>
                    <div id="migrateStatus" class="status" style="min-height:2.5em;"></div>
                    <div id="migrationLog" class="status" style="margin-top:8px;font-size:0.85em;line-height:1.4em;min-height:3.5em;white-space:pre-wrap;">Kein Lauf protokolliert.</div>
                    <div style="color:var(--accent);font-size:0.95em;margin-top:1rem;">‚ÑπÔ∏è Noch keine Migration durchgef√ºhrt</div>
                    <div style="color:var(--accent);font-size:0.95em;">‚ÑπÔ∏è √úbersprungen (da vorhanden)</div>
                </div>
            </div>
        </div>

        <div id="modal-delete" class="admin-modal">
            <div class="modal-overlay" onclick="closeAdminModal('modal-delete')"></div>
            <div class="modal-box">
                <div class="modal-header">
                    <h2>üóëÔ∏è Eintrag l√∂schen</h2>
                    <button class="modal-close" onclick="closeAdminModal('modal-delete')">‚úï</button>
                </div>
                <div class="modal-body">
                    <div class="note">Datensatz per ID entfernen</div>
                    <label for="deleteTable">Tabelle</label>
                    <select id="deleteTable">
                        <option value="material">material</option>
                        <option value="spool">spool</option>
                        <option value="printer">printer</option>
                        <option value="job">job</option>
                        <option value="userflag">userflag</option>
                        <option value="setting">setting</option>
                    </select>
                    <label for="deleteId">ID</label>
                    <input id="deleteId" type="text" placeholder="UUID oder PK" />
                    <button id="deleteBtn" class="danger" style="width:100%;margin-top:1rem;">üóëÔ∏è EINTRAG L√ñSCHEN</button>
                    <div id="deleteStatus" class="status"></div>
                </div>
            </div>
        </div>

        <div id="modal-welcome" class="admin-modal">
            <div class="modal-overlay" onclick="closeAdminModal('modal-welcome')"></div>
            <div class="modal-box">
                <div class="modal-header">
                    <h2>üëã Begr√º√üungstext</h2>
                    <button class="modal-close" onclick="closeAdminModal('modal-welcome')">‚úï</button>
                </div>
                <div class="modal-body">
                    <label>Text f√ºr das Willkommens-Popup</label>
                    <textarea id="welcomeText" placeholder="Text f√ºr das Willkommens-Popup..." style="min-height:120px;"></textarea>
                    <div style="display:flex;gap:10px;margin-top:1rem;">
                        <button style="flex:1;" onclick="saveWelcomeText()">üíæ Speichern</button>
                        <button style="flex:1;" onclick="triggerWelcomePopup()">‚ñ∂Ô∏è Popup ausl√∂sen</button>
                    </div>
                    <div id="welcomeStatus" class="status" style="margin-top:1rem;"></div>
                </div>
            </div>
        </div>

        <div id="modal-db" class="admin-modal">
            <div class="modal-overlay" onclick="closeAdminModal('modal-db')"></div>
            <div class="modal-box modal-large">
                <div class="modal-header">
                    <h2>üóÑÔ∏è Datenbank-Editor</h2>
                    <button class="modal-close" onclick="closeAdminModal('modal-db')">‚úï</button>
                </div>
                <div class="modal-body">
                    <p class="note">F√ºhre beliebige SQL-Befehle aus (INSERT, UPDATE, DELETE, CREATE, ALTER, DROP). <b>Vorsicht:</b> √Ñnderungen sind direkt wirksam!</p>
                    <textarea id="dbEditorQuery" style="min-height:120px;margin-bottom:1rem;"></textarea>
                    <div style="display:flex;gap:10px;margin-bottom:1rem;">
                        <button id="dbEditorExecute">‚ñ∂Ô∏è Ausf√ºhren</button>
                        <button id="dbEditorClear">üóëÔ∏è Clear</button>
                    </div>
                    <div style="margin: 1rem 0;">
                        <span style="color:var(--text-dim);font-size:0.95em;font-weight:500;display:block;margin-bottom:0.7em;">SQL-Beispiele:</span>
                        <div style="display:flex;gap:0.7em;">
                            <button type="button" data-sql-example="update" class="sql-example">UPDATE</button>
                            <button type="button" data-sql-example="insert" class="sql-example">INSERT</button>
                            <button type="button" data-sql-example="delete" class="sql-example">DELETE</button>
                        </div>
                    </div>
                    <div id="dbEditorOutput" style="background:rgba(5,10,18,0.8);padding:12px;border-radius:8px;min-height:32px;margin-top:1rem;border:1px solid rgba(92,211,255,0.2);font-size:0.9em;color:var(--text-dim);"></div>
                </div>
            </div>
        </div>

        <div id="modal-coverage" class="admin-modal">
            <div class="modal-overlay" onclick="closeAdminModal('modal-coverage')"></div>
            <div class="modal-box">
                <div class="modal-header">
                    <h2>üìä Coverage</h2>
                    <button class="modal-close" onclick="closeAdminModal('modal-coverage')">‚úï</button>
                </div>
                <div class="modal-body">
                    <div class="note">Coverage-Auswertung ohne Terminal</div>
                    <div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:1rem;">
                        <button id="coverageRunBtn">‚ñ∂Ô∏è Coverage ausf√ºhren</button>
                        <button id="coverageReportBtn" disabled>üìÑ Coverage-Report √∂ffnen</button>
                    </div>
                    <div id="coverageStatus" class="status"></div>
                </div>
            </div>
        </div>

        <div id="modal-tables" class="admin-modal">
            <div class="modal-overlay" onclick="closeAdminModal('modal-tables')"></div>
            <div class="modal-box modal-large">
                <div class="modal-header">
                    <h2>üóÑÔ∏è Datenbank-Tabellen</h2>
                    <button class="modal-close" onclick="closeAdminModal('modal-tables')">‚úï</button>
                </div>
                <div class="modal-body">
                    <div class="note">Schema-√úbersicht mit Spalten, Typen und Datenvorschau</div>
                    <div id="dbTables" style="color:var(--text-dim);min-height:100px;">L√§dt...</div>
                </div>
            </div>
        </div>

        <div id="modal-debug-settings" class="admin-modal">
            <div class="modal-overlay" onclick="closeAdminModal('modal-debug-settings')"></div>
            <div class="modal-box">
                <div class="modal-header">
                    <h2>‚öôÔ∏è Debug-Einstellungen</h2>
                    <button class="modal-close" onclick="closeAdminModal('modal-debug-settings')">‚úï</button>
                </div>
                <div class="modal-body">
                    <div class="note">Verwaltung von Debug-bezogenen Benutzereinstellungen</div>

                    <div style="margin-top:20px;padding:16px;background:rgba(156,39,176,0.1);border:1px solid rgba(156,39,176,0.3);border-radius:8px;">
                        <h3 style="margin:0 0 8px 0;font-size:16px;color:#ce93d8;">Pro-Mode Warnung</h3>
                        <p style="margin:0 0 12px 0;color:var(--text-dim);font-size:14px;">
                            Status: <span id="proModeStatus" style="font-weight:600;color:#ce93d8;">L√§dt...</span>
                        </p>
                        <p style="margin:0 0 16px 0;color:var(--text-muted);font-size:13px;">
                            Setzt die "Ich wei√ü was ich mache" Best√§tigung zur√ºck. Der Warndialog wird beim n√§chsten Aktivieren von Pro-Mode erneut angezeigt.
                        </p>
                        <button id="btnResetProMode" class="admin-btn" onclick="resetProModeWarning()">
                            üîÑ Warnung zur√ºcksetzen
                        </button>
                        <div id="proModeResult" style="margin-top:12px;font-size:13px;"></div>
                    </div>
                </div>
            </div>
        </div>

        <section class="admin-card" id="admin-notifications" style="grid-column: 1 / -1;">
                <div class="notif-header-modern">
                    <div>
                        <p class="eyebrow">Benachrichtigungen</p>
                        <h2>Globale Alerts</h2>
                        <p class="subtitle" style="margin:8px 0 0 0;color:var(--text-dim);">Verwalte systemweite Benachrichtigungen f√ºr alle Benutzer</p>
                    </div>
                    <button class="btn-add-notif" id="btn-new-notification">
                        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
                        </svg>
                        Neue Benachrichtigung
                    </button>
                </div>

                <!-- Notification Cards Grid -->
                <div id="notification-cards-container" class="notif-cards-grid"></div>
            </section>
        </main>
    </div>
    <script src="/frontend/admin_db_editor.js"></script>
    <script src="/frontend/js/admin_notifications.js"></script>
    <script>
    // ===== MODAL SYSTEM =====
    function openAdminModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';

            // Lade Begr√º√üungstext, wenn Welcome-Modal ge√∂ffnet wird
            if (modalId === 'modal-welcome') {
                loadWelcomeText();
            }
        }
    }
    
    function closeAdminModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.remove('active');
            document.body.style.overflow = 'auto';
        }
    }
    
    // Escape key closes modal
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            const activeModals = document.querySelectorAll('.admin-modal.active');
            if (activeModals.length > 0) {
                const lastModal = activeModals[activeModals.length - 1];
                closeAdminModal(lastModal.id);
            }
        }
    });
    
    // ===== MIGRATION =====
    const migrateBtn = document.getElementById('migrateBtn');
    const migrateStatus = document.getElementById('migrateStatus');
    const migrationLog = document.getElementById('migrationLog');

    const updateMigrationLog = (text) => {
        if (!migrationLog) return;
        migrationLog.textContent = text || 'Keine Ausgabe';
    };

    const updateMigrationStatus = (message) => {
        if (!migrateStatus) return;
        migrateStatus.innerText = message;
    };

    migrateBtn?.addEventListener('click', async function () {
        if (!migrateBtn) return;
        const originalLabel = migrateBtn.innerText;
        migrateBtn.disabled = true;
        migrateBtn.innerText = 'Migration l√§uft‚Ä¶';
        updateMigrationStatus('Migration wird ausgef√ºhrt...');
        updateMigrationLog('Befehl wird gestartet‚Ä¶');

        try {
            const res = await fetch('/api/admin/migrate', { method: 'POST' });
            const data = await res.json();
            if (data.success) {
                updateMigrationStatus('Migration abgeschlossen!');
                updateMigrationLog(data.output?.trim() || 'Keine Ausgabe.');
            } else {
                updateMigrationStatus('Fehler: ' + (data.error || 'Unbekannt'));
                updateMigrationLog(data.error || 'Fehler beim Ausf√ºhren.');
            }
        } catch (e) {
            updateMigrationStatus('Fehler beim Ausf√ºhren!');
            updateMigrationLog(e.message || 'Netzwerkfehler oder Timeout.');
        } finally {
            migrateBtn.disabled = false;
            migrateBtn.innerText = originalLabel;
        }
    });
    // Eintrag l√∂schen
    document.getElementById('deleteBtn').onclick = async function() {
        const table = document.getElementById('deleteTable').value;
        const id = document.getElementById('deleteId').value.trim();
        if (!id) {
            document.getElementById('deleteStatus').innerText = 'Bitte eine ID angeben!';
            return;
        }
        document.getElementById('deleteStatus').innerText = 'L√∂sche...';
        try {
            const res = await fetch('/api/admin/delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ table, id })
            });
            const data = await res.json();
            if(data.success) {
                document.getElementById('deleteStatus').innerText = `Eintrag aus ${table} mit ID ${id} gel√∂scht!`;
            } else {
                document.getElementById('deleteStatus').innerText = 'Fehler: ' + (data.error || 'Unbekannt');
            }
        } catch(e) {
            document.getElementById('deleteStatus').innerText = 'Fehler beim L√∂schen!';
        }
    };
    </script>
    <script>
    async function loadWelcomeText() {
        try {
            const res = await fetch('/api/admin/greeting');
            const data = await res.json();
            document.getElementById('welcomeText').value = data.greeting_text || '';
        } catch (e) {
            document.getElementById('welcomeStatus').innerText = 'Fehler beim Laden.';
        }
    }
    async function saveWelcomeText() {
        const text = document.getElementById('welcomeText').value;
        try {
            const res = await fetch('/api/admin/greeting', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ greeting_text: text })
            });
            const data = await res.json();
            if(data.success) {
                document.getElementById('welcomeStatus').innerText = 'Gespeichert!';
            } else {
                document.getElementById('welcomeStatus').innerText = 'Fehler beim Speichern!';
            }
        } catch (e) {
            document.getElementById('welcomeStatus').innerText = 'Fehler beim Speichern!';
        }
    }
    async function triggerWelcomePopup() {
        // Setze das User-Flag f√ºr den aktuellen User zur√ºck (Popup wird beim n√§chsten Dashboard-Start angezeigt)
        const userId = localStorage.getItem('fh_userid');
        if (!userId) {
            document.getElementById('welcomeStatus').innerText = 'Kein User gefunden!';
            return;
        }
        try {
            await fetch(`/api/user/flag/${userId}/welcome_popup`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ value: false })
            });
            document.getElementById('welcomeStatus').innerText = 'Popup wird beim n√§chsten Dashboard-Start angezeigt!';
        } catch(e) {
            document.getElementById('welcomeStatus').innerText = 'Fehler beim Zur√ºcksetzen!';
        }
    }
    function logout() {
        fetch('/api/admin/logout', { method: 'POST' })
            .finally(() => {
                window.location.href = '/admin';
            });
    }
    const coverageRunBtn = document.getElementById('coverageRunBtn');
    const coverageReportBtn = document.getElementById('coverageReportBtn');
    const coverageStatus = document.getElementById('coverageStatus');

    async function refreshCoverageReportButton() {
        if (!coverageReportBtn) {
            return;
        }
        try {
            const res = await fetch('/api/admin/coverage/report', { method: 'HEAD' });
            coverageReportBtn.disabled = !res.ok;
        } catch (e) {
            coverageReportBtn.disabled = true;
        }
    }

    coverageRunBtn?.addEventListener('click', async function () {
        if (!coverageRunBtn) return;
        coverageRunBtn.disabled = true;
        coverageRunBtn.innerText = 'Coverage l√§uft ‚Ä¶';
        coverageStatus.innerText = 'Coverage l√§uft ‚Ä¶';
        try {
            const res = await fetch('/api/admin/coverage/run', { method: 'POST' });
            const data = await res.json();
            coverageStatus.innerText = data.message || 'Coverage beendet';
            if (data.success) {
                await refreshCoverageReportButton();
            }
        } catch (e) {
            coverageStatus.innerText = 'Fehler beim Coverage-Lauf';
        } finally {
            coverageRunBtn.disabled = false;
            coverageRunBtn.innerText = 'Coverage ausf√ºhren';
        }
    });

    coverageReportBtn?.addEventListener('click', function () {
        window.open('/api/admin/coverage/ui', '_blank');
    });

    // ===== DEBUG SETTINGS =====
    async function loadProModeStatus() {
        try {
            const res = await fetch('/api/debug/pro-mode/status');
            const data = await res.json();
            const statusEl = document.getElementById('proModeStatus');
            if (statusEl) {
                statusEl.textContent = data.accepted ? 'Best√§tigt ‚úì' : 'Nicht best√§tigt';
                statusEl.style.color = data.accepted ? '#4caf50' : '#ff9800';
            }
        } catch (e) {
            console.error('Fehler beim Laden des Pro-Mode Status:', e);
        }
    }

    async function resetProModeWarning() {
        const btn = document.getElementById('btnResetProMode');
        const resultEl = document.getElementById('proModeResult');

        if (!btn || !resultEl) return;

        const originalText = btn.textContent;
        btn.disabled = true;
        btn.textContent = '‚è≥ Wird zur√ºckgesetzt...';
        resultEl.textContent = '';

        try {
            const res = await fetch('/api/admin/debug/reset-pro-mode', { method: 'POST' });
            const data = await res.json();

            if (data.success) {
                resultEl.innerHTML = '<span style="color:#4caf50;">‚úì Warnung wurde zur√ºckgesetzt</span>';
                await loadProModeStatus();
            } else {
                resultEl.innerHTML = '<span style="color:#f44336;">‚úó Fehler: ' + (data.error || 'Unbekannt') + '</span>';
            }
        } catch (e) {
            resultEl.innerHTML = '<span style="color:#f44336;">‚úó Fehler beim Zur√ºcksetzen</span>';
        } finally {
            btn.disabled = false;
            btn.textContent = originalText;
        }
    }

    window.addEventListener('DOMContentLoaded', () => {
        loadWelcomeText();
        refreshCoverageReportButton();
    });

    // Load Pro-Mode status when debug settings modal opens
    document.addEventListener('click', (e) => {
        if (e.target.closest('[onclick*="modal-debug-settings"]')) {
            setTimeout(loadProModeStatus, 100);
        }
    });
    </script>

    <!-- Notification Edit Modal (moved outside card to prevent clipping) -->
    <div id="notif-edit-modal" class="notif-modal">
        <div class="notif-modal-overlay" onclick="closeNotifModal()"></div>
        <div class="notif-modal-dialog">
            <div class="notif-modal-header">
                <h3 id="notif-modal-title">Neue Benachrichtigung</h3>
                <button class="notif-modal-close" onclick="closeNotifModal()">&times;</button>
            </div>
            <div class="notif-modal-body">
                <div class="form-group">
                    <label for="notif-id">ID <span class="required">*</span></label>
                    <input id="notif-id" type="text" placeholder="z.B. print_done">
                </div>
                <div class="form-group">
                    <label for="notif-label">Label</label>
                    <input id="notif-label" type="text" placeholder="Lesbarer Name">
                </div>
                <div class="form-group">
                    <label for="notif-message">Nachricht <span class="required">*</span></label>
                    <textarea id="notif-message" placeholder="Der Druck wurde erfolgreich abgeschlossen." style="min-height:80px;"></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="notif-type">Typ</label>
                        <select id="notif-type">
                            <option value="success">‚úì Success</option>
                            <option value="warn">‚ö†Ô∏è Warnung</option>
                            <option value="error">‚úï Error</option>
                            <option value="info">‚ÑπÔ∏è Info</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="notif-trigger">Trigger</label>
                        <select id="notif-trigger">
                            <option value="manual">Manuell</option>
                            <option value="print_done">Druck fertig</option>
                            <option value="print_time">Druckzeit</option>
                            <option value="error">Fehler</option>
                            <option value="material_low">Material niedrig</option>
                            <option value="temperature">Temperatur</option>
                            <option value="humidity">Luftfeuchtigkeit</option>
                            <option value="filament_weight">Filament-Gewicht</option>
                            <option value="custom">Custom</option>
                        </select>
                    </div>
                </div>
                <div class="form-checkboxes">
                    <label class="checkbox-label">
                        <input id="notif-enabled" type="checkbox" checked>
                        <span>Aktiv</span>
                    </label>
                    <label class="checkbox-label">
                        <input id="notif-persistent" type="checkbox">
                        <span>Persistent</span>
                    </label>
                </div>

                <!-- Webhook Integration -->
                <div class="form-section" style="margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--border);">
                    <h4 style="margin: 0 0 16px 0; font-size: 16px; color: var(--text);">üîó Webhook Integration (Optional)</h4>

                    <div class="form-group">
                        <label for="notif-webhook-url">Webhook URL</label>
                        <input id="notif-webhook-url" type="text" placeholder="https://discord.com/api/webhooks/... oder https://api.telegram.org/bot...">
                        <small style="color: var(--text-dim); font-size: 12px; display: block; margin-top: 4px;">
                            Sende Benachrichtigungen an Discord, Telegram oder andere Services
                        </small>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="notif-webhook-type">Webhook Typ</label>
                            <select id="notif-webhook-type">
                                <option value="">Kein Webhook</option>
                                <option value="discord">Discord</option>
                                <option value="telegram">Telegram</option>
                                <option value="slack">Slack</option>
                                <option value="custom">Custom JSON</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="notif-webhook-username">Bot Name (Optional)</label>
                            <input id="notif-webhook-username" type="text" placeholder="FilamentHub Bot">
                        </div>
                    </div>
                </div>

                <!-- Trigger Conditions -->
                <div class="form-section" id="trigger-conditions-section" style="margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--border); display: none;">
                    <h4 style="margin: 0 0 16px 0; font-size: 16px; color: var(--text);">‚öôÔ∏è Trigger Bedingungen</h4>

                    <!-- Temperature Condition -->
                    <div id="condition-temperature" class="condition-config" style="display: none;">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Operator</label>
                                <select id="temp-operator">
                                    <option value=">">Gr√∂√üer als (>)</option>
                                    <option value="<">Kleiner als (<)</option>
                                    <option value=">=">Gr√∂√üer gleich (>=)</option>
                                    <option value="<=">Kleiner gleich (<=)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Temperatur (¬∞C)</label>
                                <input type="number" id="temp-value" placeholder="z.B. 250">
                            </div>
                        </div>
                    </div>

                    <!-- Humidity Condition -->
                    <div id="condition-humidity" class="condition-config" style="display: none;">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Operator</label>
                                <select id="humidity-operator">
                                    <option value=">">Gr√∂√üer als (>)</option>
                                    <option value="<">Kleiner als (<)</option>
                                    <option value=">=">Gr√∂√üer gleich (>=)</option>
                                    <option value="<=">Kleiner gleich (<=)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Luftfeuchtigkeit (%)</label>
                                <input type="number" id="humidity-value" placeholder="z.B. 60" min="0" max="100">
                                <small style="color: var(--text-dim); font-size: 12px; display: block; margin-top: 4px;">
                                    üí° Empfohlen: < 60% f√ºr optimale Filament-Lagerung
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- Print Time Condition -->
                    <div id="condition-print_time" class="condition-config" style="display: none;">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Operator</label>
                                <select id="printtime-operator">
                                    <option value=">">L√§nger als (>)</option>
                                    <option value="<">K√ºrzer als (<)</option>
                                    <option value=">=">Mind. (>=)</option>
                                    <option value="<=">Max. (<=)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Druckzeit (Stunden)</label>
                                <input type="number" id="printtime-value" placeholder="z.B. 5" step="0.5">
                            </div>
                        </div>
                    </div>

                    <!-- Filament Weight Condition -->
                    <div id="condition-filament_weight" class="condition-config" style="display: none;">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Operator</label>
                                <select id="filament-operator">
                                    <option value="<">Weniger als (<)</option>
                                    <option value="<=">H√∂chstens (<=)</option>
                                    <option value=">">Mehr als (>)</option>
                                    <option value=">=">Mindestens (>=)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Filament-Gewicht (g)</label>
                                <input type="number" id="filament-value" placeholder="z.B. 100">
                            </div>
                        </div>
                    </div>

                    <!-- Custom Code Condition -->
                    <div id="condition-custom" class="condition-config" style="display: none;">
                        <div class="form-group">
                            <label>JavaScript Code (return true/false)</label>
                            <textarea id="custom-condition-code" placeholder="// Beispiel:&#10;return printerData.temp > 250 && printerData.temp < 300;" style="min-height: 100px; font-family: 'Courier New', monospace;"></textarea>
                            <small style="color: var(--text-dim); font-size: 12px; display: block; margin-top: 4px;">
                                Verf√ºgbare Variablen: printerData, jobData, materialData
                            </small>
                        </div>
                    </div>
                </div>
            </div>
            <div class="notif-modal-footer">
                <button class="btn-secondary" onclick="closeNotifModal()">Abbrechen</button>
                <div style="display:flex;gap:8px;">
                    <button class="btn-test" id="btn-test">‚ñ∂Ô∏è Testen</button>
                    <button class="btn-primary" id="btn-save">üíæ Speichern</button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
