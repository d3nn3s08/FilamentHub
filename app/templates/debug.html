{% extends "layout.html" %}

{% block extra_styles %}
<link rel="stylesheet" href="/static/css/debug_tabs.css">
{% endblock %}

{% block content %}
<div class="page-wrapper">
    <p class="eyebrow">INTERNE DIAGNOSE-, SYSTEM- UND LIVE-STATUS-ANSICHT</p>
    <h1 class="title">Debug Center</h1>
    <p class="subtitle">Zentrale Uebersicht fuer Monitoring, Analyse und Systemstatus.</p>

    <style>
        .debug-tabs { display:flex; gap:8px; margin-bottom:12px; }
        .debug-tab { padding:8px 12px; border-radius:8px; cursor:pointer; background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.08); color:#fff; }
        .debug-tab.active { background:rgba(46,134,222,0.3); border-color:rgba(46,134,222,0.6); }
        .panel { background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.08); border-radius:10px; padding:12px; }
        .system-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:12px; }
        .status-badge { padding:2px 8px; border-radius:6px; background:rgba(255,255,255,0.08); color:rgba(255,255,255,0.85); font-weight:600; }
        .status-ok { background:rgba(46,204,113,0.2); color:#8ef0b5; }
        .status-warn { background:rgba(241,196,15,0.18); color:#ffd666; }
        .status-error { background:rgba(231,76,60,0.2); color:#ff9a8a; }
        .status-idle { background:rgba(255,255,255,0.08); color:rgba(255,255,255,0.7); }
    </style>

    <div class="debug-tabs">
        <div class="debug-tab active" data-tab="system" data-mode="lite">System Status</div>
        <div class="debug-tab" data-tab="performance" data-mode="lite">Performance</div>
        <div class="debug-tab" data-tab="scanner" data-mode="lite">Printer Scanner</div>
        <div class="debug-tab pro-only" data-tab="logs" data-mode="pro" style="display:none;">Log Viewer</div>
        <div class="debug-tab pro-only" data-tab="config" data-mode="pro" style="display:none;">Config Manager</div>
    </div>
    <div class="debug-mode-toggle">
        <div class="debug-mode-pill">
            <button id="debugModeLite" class="debug-mode-btn active">Lite</button>
            <button id="debugModePro" class="debug-mode-btn">Pro</button>
        </div>
        <span class="debug-mode-label" id="debugModeLabel">Mode: Lite</span>
    </div>

    <div class="debug-panels">
        <div id="panel-system" class="debug-panel">
            <div class="panel" id="systemHealthBox" style="margin-bottom:12px;">
                <p class="eyebrow">System Health</p>
                <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
                    <span id="healthBadge" class="status-badge status-warn">Warning</span>
                    <span id="healthText" class="health-text">Some services require attention</span>
                </div>
                <ul id="healthReasons" class="health-reasons pro-only">
                    <li>System is operating normally</li>
                </ul>
            </div>
            <div class="system-grid">
                <div class="panel">
                    <p class="eyebrow">Application</p>
                    <h3 id="sys_app_name" style="margin:4px 0;">FilamentHub</h3>
                    <p class="subtitle" id="sys_app_version">0.0.0</p>
                    <div class="subtitle" id="sys_app_env">development</div>
                    <div class="subtitle" id="sys_app_uptime">0</div>
                </div>

                <div class="panel">
                    <p class="eyebrow">Systemressourcen</p>
                    <div style="display:flex;flex-direction:column;gap:6px;">
                        <div><strong>CPU:</strong> <span id="sys_cpu_usage">-</span> <span id="sys_cpu_cores" style="color:var(--text-dim);margin-left:6px;">n/a</span></div>
                        <div><strong>RAM:</strong> <span id="sys_ram_usage">-</span> <span id="sys_ram_detail" style="color:var(--text-dim);margin-left:6px;">-</span></div>
                        <div><strong>Disk:</strong> <span id="sys_disk_usage">-</span> <span id="sys_disk_detail" style="color:var(--text-dim);margin-left:6px;">-</span></div>
                    </div>
                </div>

                <div class="panel">
                    <p class="eyebrow">Backend & Services Status</p>
                    <div style="display:flex;flex-direction:column;gap:4px;line-height:1.3;">
                        <div><strong>API:</strong> <span class="info-icon" title="Status of the internal REST API. Indicates whether requests can be processed.">i</span> <span id="apiStatus" class="status-badge" title="API reachable (HTTP responding)">offline</span></div>
                        <div><strong>DB:</strong> <span class="info-icon" title="Database connection state. Connected means queries can be executed.">i</span> <span id="dbStatus" class="status-badge" title="Database reachable (SELECT 1 OK)">offline</span></div>
                        <div><strong>MQTT:</strong> <span class="info-icon" title="MQTT service status. Disabled means no broker connection is active.">i</span> <span id="mqttStatus" class="status-badge" title="MQTT client connected to broker">offline</span></div>
                        <div><strong>WebSocket:</strong> <span class="info-icon" title="WebSocket server state. Listening means the server accepts connections.">i</span> <span id="wsStatus" class="status-badge" title="WebSocket has active client connection(s)">offline</span> <small id="wsClients" style="color:var(--text-dim); margin-left:6px;"></small></div>
                    </div>
                </div>

                <div class="panel">
                    <p class="eyebrow">Runtime & Requests <span id="sys_runtime_state" class="status-badge status-idle" style="margin-left:6px;" title="No recent requests; showing idle state">Idle</span></p>
                    <div style="display:flex;flex-direction:column;gap:6px;">
                        <div><strong>Requests/min:</strong> <span id="sys_runtime_rpm">-</span></div>
                        <div><strong>Avg Response:</strong> <span class="info-icon" title="Average response time of HTTP requests. High values may indicate load or blocking operations.">i</span> <span id="sys_runtime_avg">-</span></div>
                    </div>
                </div>

                <div class="panel pro-only">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <p class="eyebrow">API Detail</p>
                        <span class="status-badge status-ok pro-badge">PRO</span>
                    </div>
                    <div>Status: <span id="proApiStatus">-</span></div>
                    <div>Response: <span id="proApiLatency">-</span></div>
                </div>

                <div class="panel pro-only">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <p class="eyebrow">DB Detail</p>
                        <span class="status-badge status-ok pro-badge">PRO</span>
                    </div>
                    <div>Status: <span id="proDbStatus">-</span></div>
                    <div>Type: <span id="proDbType">-</span></div>
                </div>

                <div class="panel pro-only">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <p class="eyebrow">WebSocket Detail</p>
                        <span class="status-badge status-ok pro-badge">PRO</span>
                    </div>
                    <div>Status: <span id="proWsStatus">-</span></div>
                    <div>Clients: <span id="proWsClients">-</span></div>
                </div>

                <div class="panel pro-only">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <p class="eyebrow">MQTT Detail</p>
                        <span class="status-badge status-ok pro-badge">PRO</span>
                    </div>
                    <div>Status: <span id="proMqttStatus">-</span></div>
                    <div>Broker: <span id="proMqttBroker">-</span></div>
                </div>

                <div class="panel pro-only">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <p class="eyebrow">Warum Warnung?</p>
                        <span class="status-badge status-ok pro-badge">PRO</span>
                    </div>
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
                        <span id="whyBadgePro" class="status-badge status-ok">OK</span>
                        <span style="color:var(--text-dim);">Erklaert aktive Warnhinweise im System.</span>
                    </div>
                    <ul id="whyReasonsPro" class="health-reasons" style="margin-top:4px;">
                        <li>Keine Warnungen aktiv.</li>
                    </ul>
                </div>
            </div>
            <div class="pro-only pro-coming">
                <div class="debug-card">
                    <p class="eyebrow">AMS Detail</p>
                    <div>Coming soon</div>
                </div>
                <div class="debug-card">
                    <p class="eyebrow">JSON Inspect</p>
                    <div>Coming soon</div>
                </div>
            </div>
        </div>

        <div id="panel-performance" class="debug-panel" style="display:none;">
            <div class="panel">
                <p class="eyebrow">Performance (Lite)</p>
                <div id="perfLoading" class="subtitle">Loading performance...</div>
                <div id="perfError" class="subtitle" style="display:none;color:var(--accent, #f39c12);">Performance data not available</div>
                <div class="system-grid" id="perfGrid" style="margin-top:8px;">
                    <div class="panel" style="padding:10px;">
                        <div style="display:flex;justify-content:space-between;align-items:center;">
                            <span><strong>CPU</strong></span>
                            <span id="perfCpuBadge" class="status-badge status-idle">Idle</span>
                        </div>
                        <div id="perfCpuValue" style="font-size:1.3rem;margin:6px 0 2px;">-</div>
                        <div id="perfCpuSub" style="color:var(--text-dim);">-</div>
                    </div>
                    <div class="panel" style="padding:10px;">
                        <div style="display:flex;justify-content:space-between;align-items:center;">
                            <span><strong>RAM</strong></span>
                            <span id="perfRamBadge" class="status-badge status-idle">Idle</span>
                        </div>
                        <div id="perfRamValue" style="font-size:1.3rem;margin:6px 0 2px;">-</div>
                        <div id="perfRamSub" style="color:var(--text-dim);">-</div>
                    </div>
                    <div class="panel" style="padding:10px;">
                        <div style="display:flex;justify-content:space-between;align-items:center;">
                            <span><strong>Disk</strong></span>
                            <span id="perfDiskBadge" class="status-badge status-idle">Idle</span>
                        </div>
                        <div id="perfDiskValue" style="font-size:1.3rem;margin:6px 0 2px;">-</div>
                        <div id="perfDiskSub" style="color:var(--text-dim);">-</div>
                    </div>
                    <div class="panel" style="padding:10px;">
                        <div style="display:flex;justify-content:space-between;align-items:center;">
                            <span><strong>Backend Uptime</strong></span>
                            <span id="perfUptimeBadge" class="status-badge status-idle">Idle</span>
                        </div>
                        <div id="perfUptimeValue" style="font-size:1.3rem;margin:6px 0 2px;">-</div>
                        <div id="perfUptimeSub" style="color:var(--text-dim);">-</div>
                    </div>
                </div>
            </div>
        </div>
        <div id="panel-pro-placeholder" class="debug-panel" data-mode="pro" style="display:none;">
            <div class="panel">
                <p class="eyebrow">Pro Mode</p>
                <p class="subtitle">Pro-Funktionen werden hier angezeigt.</p>
            </div>
        </div>
        <div id="panel-scanner" class="debug-panel" style="display:none;">
            <div class="panel">
                <div class="scanner-header-card">
                    <div class="scanner-header-top">
                        <div>
                            <p class="eyebrow">Printer Scanner (Lite)</p>
                            <div class="scanner-hostline"><span id="netHostname">-</span><span class="dot-sep">.</span><span id="netLocalIp">-</span></div>
                            <div class="scanner-range">Scan Range: <span id="netSuggestedRange">-</span></div>
                        </div>
                        <div class="scanner-actions">
                            <button id="scannerQuickScan" class="btn btn-primary">Quick Scan (LAN)</button>
                        </div>
                    </div>
                </div>
                <div id="scannerResults" class="scanner-grid">
                    <div class="badge badge-idle">No printers detected</div>
                </div>
            </div>
            <div class="panel pro-only" data-mode="pro" style="margin-top:12px;">
                <p class="eyebrow">Scanner Pro</p>
                <div class="system-grid" style="margin-top:6px;">
                    <div class="panel scanner-pro-card pro-disabled-card pro-only" data-mode="pro">
                        <div class="scanner-pro-head">
                            <span class="pro-icon fa fa-network-wired" aria-hidden="true"></span>
                            <span><strong>Deep Probe</strong></span>
                            <span class="status-badge status-ok pro-badge">PRO</span>
                            <span id="proProbeBadge" class="status-badge status-idle">IDLE</span>
                        </div>
                        <p class="subtitle">Führt eine erweiterte Verbindungs- und Erreichbarkeitsprüfung für das ausgewählte Gerät durch.</p>
                        <div style="margin-top:8px;">
                            <button id="proProbeStart" class="btn btn-secondary pro-btn-disabled pro-only-inline" disabled>Probe starten</button>
                        </div>
                        <div style="margin-top:6px;color:var(--text-dim);" id="proProbeStatus">Noch keine Probe-Daten vorhanden.</div>
                        <div style="margin-top:4px;color:var(--text-dim);" id="proProbeLatency">Antwortzeit: -</div>
                        <div style="margin-top:4px;color:var(--text-dim);" id="proProbeType">Erkannt: -</div>
                        <div style="margin-top:4px;color:var(--text-dim);" id="proProbeError">Fehlerklasse: -</div>
                        <div style="margin-top:4px;color:var(--text-dim);" id="proProbeHttp">HTTP-Status: -</div>
                        <div style="margin-top:4px;color:var(--text-dim);" id="proProbeMessage">Hinweis: -</div>
                    </div>
                    <div class="panel scanner-pro-card pro-disabled-card pro-only" data-mode="pro">
                        <div class="scanner-pro-head">
                            <span class="pro-icon fa fa-fingerprint" aria-hidden="true"></span>
                            <span><strong>Geraete-Fingerprint</strong></span>
                            <span class="status-badge status-ok pro-badge">PRO</span>
                        </div>
                        <p class="subtitle">Ermittelt den tatsaechlichen Geraetetyp anhand technischer Merkmale.</p>
                        <div style="margin-top:8px;">
                            <button id="proFingerprintStart" class="btn btn-secondary pro-btn-disabled pro-only-inline" disabled>Fingerprint starten</button>
                        </div>
                        <div style="margin-top:6px;color:var(--text-dim);" id="proFingerprintStatus">Status: -</div>
                        <div style="margin-top:4px;color:var(--text-dim);" id="proFingerprintType">Erkannt: -</div>
                        <div style="margin-top:4px;color:var(--text-dim);" id="proFingerprintConfidence">Vertrauensgrad: -</div>
                        <div style="margin-top:6px;color:var(--text-dim);">Ports:</div>
                        <ul id="proFingerprintPorts" style="margin-top:2px;color:var(--text-dim);padding-left:16px;">
                            <li>-</li>
                        </ul>
                    </div>
                    <div class="panel scanner-pro-card pro-disabled-card pro-only" data-mode="pro">
                        <div class="scanner-pro-head">
                            <span class="pro-icon fa fa-code" aria-hidden="true"></span>
                            <span><strong>Rohdaten / JSON-Ansicht</strong></span>
                            <span class="status-badge status-ok pro-badge">PRO</span>
                        </div>
                        <p class="subtitle">Einmalige Rohdaten-Aufnahme zur Analyse und Fehlersuche.</p>
                        <div style="margin-top:8px;">
                            <button class="btn btn-secondary pro-btn-disabled pro-only-inline" disabled title="Pro-Funktion - folgt in Kuerze">Snapshot erfassen</button>
                        </div>
                        <div class="pro-hint">Pro-Funktion - folgt in Kuerze</div>
                        <div style="margin-top:6px;color:var(--text-dim);">Es wurde noch kein Snapshot erstellt.</div>
                    </div>
                </div>
            </div>
        </div>
        <div id="panel-config" class="debug-panel pro-only" data-mode="pro" style="display:none;">
            <div class="system-grid" style="margin-top:10px;">
                <div class="panel">
                    <p class="eyebrow">System Health</p>
                    <label style="display:flex;align-items:center;gap:8px;margin:6px 0;">
                        <input type="checkbox" id="cfg_health_enabled" disabled>
                        <span>Health-Überwachung aktiv</span>
                    </label>
                    <label style="display:flex;flex-direction:column;gap:4px;margin:6px 0;">
                        <span>Warn-Schwelle Latenz (ms)</span>
                        <input type="number" id="cfg_health_warn_latency" placeholder="600" disabled>
                    </label>
                    <label style="display:flex;flex-direction:column;gap:4px;margin:6px 0;">
                        <span>Fehler-Schwelle Latenz (ms)</span>
                        <input type="number" id="cfg_health_error_latency" placeholder="1200" disabled>
                    </label>
                    <small style="color:var(--text-dim);">Steuert die Ampel-Logik im System Health Bereich.</small>
                    <div style="display:flex;gap:8px;margin-top:8px;">
                        <button class="btn btn-secondary" id="cfg_health_cancel" disabled>Abbrechen</button>
                        <button class="btn btn-primary" id="cfg_health_save" disabled>Speichern</button>
                    </div>
                </div>
                <div class="panel">
                    <p class="eyebrow">Logging</p>
                    <label style="display:flex;flex-direction:column;gap:4px;margin:6px 0;">
                        <span>Log-Level</span>
                        <select id="cfg_logging_level" disabled>
                            <option>off</option>
                            <option>basic</option>
                            <option>verbose</option>
                        </select>
                    </label>
                    <label style="display:flex;align-items:center;gap:8px;margin:6px 0;">
                        <input type="checkbox" id="cfg_logging_to_file" disabled>
                        <span>Logs in Datei schreiben</span>
                    </label>
                    <div style="color:var(--text-dim); font-size:12px; margin-top:6px; line-height:1.3;">
                        <div>off = kein Logging, basic = Basis-Events, verbose = detailliertes Debug.</div>
                        <div>Module aktiv: App <span id="cfg_logging_status_app">false</span>, Bambu <span id="cfg_logging_status_bambu">false</span>, Klipper <span id="cfg_logging_status_klipper">false</span>, MQTT <span id="cfg_logging_status_mqtt">false</span></div>
                    </div>
                    <div style="display:flex;gap:8px;margin-top:8px;">
                        <button class="btn btn-secondary" id="cfg_logging_cancel" disabled>Abbrechen</button>
                        <button class="btn btn-primary" id="cfg_logging_save" disabled>Speichern</button>
                    </div>
                </div>
                <div class="panel">
                    <p class="eyebrow">Runtime Monitoring</p>
                    <label style="display:flex;align-items:center;gap:8px;margin:6px 0;">
                        <input type="checkbox" id="cfg_runtime_enabled" disabled>
                        <span>Runtime-Überwachung aktiv</span>
                    </label>
                    <label style="display:flex;flex-direction:column;gap:4px;margin:6px 0;">
                        <span>Poll-Intervall (ms)</span>
                        <input type="number" id="cfg_runtime_poll_interval" placeholder="2000" disabled>
                    </label>
                    <small style="color:var(--text-dim);">Beeinflusst Aktualisierung von Runtime & Requests.</small>
                    <div style="display:flex;gap:8px;margin-top:8px;">
                        <button class="btn btn-secondary" id="cfg_runtime_cancel" disabled>Abbrechen</button>
                        <button class="btn btn-primary" id="cfg_runtime_save" disabled>Speichern</button>
                    </div>
                </div>
                <div class="panel">
                    <p class="eyebrow">Scanner (Pro)</p>
                    <label style="display:flex;align-items:center;gap:8px;margin:6px 0;">
                        <input type="checkbox" id="cfg_scanner_deep_probe" disabled>
                        <span>Deep-Probe aktivieren</span>
                    </label>
                    <label style="display:flex;align-items:center;gap:8px;margin:6px 0;">
                        <input type="checkbox" id="cfg_scanner_fingerprint" disabled>
                        <span>Geräte-Fingerprint erlauben</span>
                    </label>
                    <div style="display:flex;gap:8px;margin-top:8px;">
                        <button class="btn btn-secondary" id="cfg_scanner_cancel" disabled>Abbrechen</button>
                        <button class="btn btn-primary" id="cfg_scanner_save" disabled>Speichern</button>
                    </div>
                </div>
                <div class="panel">
                    <p class="eyebrow">Geräte-Fingerprint</p>
                    <label style="display:flex;align-items:center;gap:8px;margin:6px 0;">
                        <input type="checkbox" id="cfg_fingerprint_enabled" disabled>
                        <span>Fingerprint-System aktiv</span>
                    </label>
                    <label style="display:flex;flex-direction:column;gap:4px;margin:6px 0;">
                        <span>Prüf-Ports</span>
                        <input type="text" id="cfg_fingerprint_ports" placeholder="8883, 6000, 7125" disabled>
                    </label>
                    <label style="display:flex;flex-direction:column;gap:4px;margin:6px 0;">
                        <span>Timeout (ms)</span>
                        <input type="number" id="cfg_fingerprint_timeout" placeholder="1500" disabled>
                    </label>
                    <small style="color:var(--text-dim);">Ermittelt den tatsächlichen Gerätetyp anhand technischer Merkmale (TCP-Port-Reaktion, Protokollverhalten).</small>
                    <div style="display:flex;gap:8px;margin-top:8px;">
                        <button class="btn btn-secondary" id="cfg_fingerprint_cancel" disabled>Abbrechen</button>
                        <button class="btn btn-primary" id="cfg_fingerprint_save" disabled>Speichern</button>
                    </div>
                </div>
            </div>
            <p class="subtitle" style="margin-top:10px;">Änderungen speichern – folgt in späterer Pro-Version</p>
        </div>
        <div id="panel-logs" class="debug-panel pro-only" data-mode="pro" style="display:none;">
            <div class="panel pro-only">
                <p class="eyebrow">Log Uebersicht</p>
                <p class="subtitle">Dieser Bereich zeigt System- und Diagnose-Logs zur Analyse.</p>
                <div id="log-overview-status" style="margin-top:6px;color:var(--text-dim);">Aktuell sind keine Logs geladen.</div>
            </div>
            <div class="panel pro-only" style="margin-top:10px;">
                <p class="eyebrow">Log Eintraege</p>
                <div id="log-entries" style="color:var(--text-dim);">Log-Eintraege werden hier angezeigt, sobald sie geladen werden.</div>
            </div>
            <div class="panel pro-only" style="margin-top:10px;">
                <p class="eyebrow">Log Filter</p>
                <p class="subtitle">Filterfunktionen stehen im Pro-Modus zur Verfuegung.</p>
                <div style="display:flex;flex-direction:column;gap:8px;margin-top:6px;max-width:320px;">
                    <label style="display:flex;flex-direction:column;gap:4px;">
                        <span>Level</span>
                        <select disabled>
                            <option>Alle</option>
                            <option>Info</option>
                            <option>Warn</option>
                            <option>Error</option>
                        </select>
                    </label>
                    <label style="display:flex;flex-direction:column;gap:4px;">
                        <span>Modul</span>
                        <select disabled>
                            <option>Alle</option>
                            <option>App</option>
                            <option>Bambu</option>
                            <option>Klipper</option>
                            <option>MQTT</option>
                        </select>
                    </label>
                    <label style="display:flex;flex-direction:column;gap:4px;">
                        <span>Suche</span>
                        <input type="text" disabled placeholder="Filter folgt" />
                    </label>
                </div>
            </div>
            <div class="panel pro-only" style="margin-top:10px;">
                <p class="eyebrow">Log Details</p>
                <p class="subtitle">Waehle einen Log-Eintrag aus, um Details anzuzeigen.</p>
                <div id="log-detail" style="color:var(--text-dim); margin-top:6px;">Noch kein Eintrag ausgewaehlt.</div>
            </div>
        </div>
    </div>

{% endblock %}
