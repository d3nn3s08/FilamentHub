const DEBUG_VERBOSE = false;

const state = {
  mode: 'lite',
  proUnlocked: false,
  activeTab: 'system',
  intervals: {
    system: null,
    backend: null,
    perf: null,
    logs: null,
    network: null,
  },
  lastPerf: null,
  perfLoaded: false,
  lastBackendStatus: null,
  lastSystemStatus: null,
};

// Helpers
function $(id) {
  return document.getElementById(id);
}

function setText(id, value, fallback = '-') {
  const el = $(id);
  if (!el) return;
  const val = value === null || value === undefined || value === '' ? fallback : value;
  el.textContent = val;
}

function setStatusClass(el, cls) {
  if (!el) return;
  el.classList.remove('status-ok', 'status-warn', 'status-error', 'status-idle', 'status-info');
  if (cls) el.classList.add(cls);
}

function applyStatus(el, status) {
  if (!el) return;
  const normalized = String(status || '').toLowerCase();
  let cls = 'status-idle';
  if (['online', 'connected', 'reachable', 'ok', 'active'].includes(normalized)) cls = 'status-ok';
  else if (['warn', 'warning'].includes(normalized)) cls = 'status-warn';
  else if (['idle', 'disabled', 'listening'].includes(normalized)) cls = 'status-idle';
  else if (['offline', 'error', 'down', 'failed'].includes(normalized)) cls = 'status-error';
  setStatusClass(el, cls);
  el.textContent = status || '-';
}

function formatPercent(val) {
  const num = Number(val);
  if (!Number.isFinite(num)) return '-';
  return `${Math.round(num)} %`;
}

function formatUptime(sec) {
  const num = Number(sec);
  if (!Number.isFinite(num)) return '-';
  const h = Math.floor(num / 3600);
  const m = Math.floor((num % 3600) / 60);
  return `${h}h ${m}m`;
}

function addLoading(el, loading) {
  if (!el) return;
  el.classList.toggle('loading', !!loading);
}

// Central mode application
function applyDebugMode(mode) {
  const normalized = mode === 'pro' ? 'pro' : 'lite';
  state.mode = normalized;
  const tabs = document.querySelectorAll('[data-mode]');
  tabs.forEach(tab => {
    if (tab.dataset.mode === 'pro' && normalized === 'lite') {
      tab.style.display = 'none';
    } else {
      tab.style.display = '';
    }
  });
  document.getElementById('debugModeLite')?.classList.toggle('active', normalized === 'lite');
  document.getElementById('debugModePro')?.classList.toggle('active', normalized === 'pro');
  const label = document.getElementById('debugModeLabel');
  if (label) {
    label.textContent = 'Mode: ' + (normalized === 'pro' ? 'Pro' : 'Lite');
  }
  window.DEBUG_MODE = normalized;
}

function saveDebugMode(mode) {
  fetch('/api/settings', {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ debug_center_mode: mode === 'pro' ? 'pro' : 'lite' }),
  }).catch(() => {});
}

// Init
function initDebugCenter() {
  initTabs();
  initModeToggle();
  initUnlockModal();
  initLogViewer();
  initScanner();
  window.addEventListener('visibilitychange', handleVisibilityChange);
  window.addEventListener('beforeunload', stopAllIntervals);
  loadSettings();
}

document.addEventListener('DOMContentLoaded', initDebugCenter);

// Tabs
function initTabs() {
  document.querySelectorAll('.debug-tab').forEach(tab => {
    tab.addEventListener('click', () => switchTab(tab.dataset.tab));
  });
}

function switchTab(name) {
  if (!name) return;
  state.activeTab = name;
  document.querySelectorAll('.debug-panel').forEach(p => p.style.display = 'none');
  const panel = $(`panel-${name}`);
  if (panel) panel.style.display = '';
  document.querySelectorAll('.debug-tab').forEach(tab => tab.classList.toggle('active', tab.dataset.tab === name));
  handleTabVisibility();
}

function handleTabVisibility() {
  const visible = document.visibilityState === 'visible';
  const tab = state.activeTab;
  if (!visible) {
    stopAllIntervals();
    return;
  }
  stopAllIntervals();
  if (tab === 'system') startSystemIntervals();
  if (tab === 'performance') startPerformancePolling();
  if (tab === 'logs') startLogAutoRefresh();
  if (tab === 'scanner') startNetworkInterval();
}

function handleVisibilityChange() {
  handleTabVisibility();
}

function stopAllIntervals() {
  Object.keys(state.intervals).forEach(k => {
    if (state.intervals[k]) {
      clearInterval(state.intervals[k]);
      state.intervals[k] = null;
    }
  });
}

// Settings + Mode
async function loadSettings() {
  let mode = 'lite';
  try {
    const res = await fetch('/api/settings');
    const data = await res.json();
    const desiredMode = (data.debug_center_mode || 'lite').toLowerCase();
    mode = desiredMode === 'pro' ? 'pro' : 'lite';
  } catch (err) {
    if (DEBUG_VERBOSE) console.debug('Settings load failed', err);
  }
  applyDebugMode(mode);
  switchTab('system');
  startSystemIntervals();
  startNetworkInterval();
}

function initModeToggle() {
  const liteBtn = document.getElementById('debugModeLite');
  const proBtn = document.getElementById('debugModePro');
  liteBtn?.addEventListener('click', () => {
    applyDebugMode('lite');
    saveDebugMode('lite');
  });
  proBtn?.addEventListener('click', () => {
    applyDebugMode('pro');
    saveDebugMode('pro');
  });
}

function saveSettings(payload) {
  fetch('/api/settings', {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload),
  }).catch(() => {});
}

// Unlock modal
function initUnlockModal() {
  const cancel = $('#unlockCancelBtn');
  const close = $('#unlockCloseBtn');
  const confirm = $('#unlockConfirmBtn');
  if (cancel) cancel.addEventListener('click', closeUnlockModal);
  if (close) close.addEventListener('click', closeUnlockModal);
  if (confirm) confirm.addEventListener('click', unlockProMode);
}

function openUnlockModal() {
  const modal = $('#proUnlockModal');
  if (modal) modal.style.display = 'flex';
}

function closeUnlockModal() {
  const modal = $('#proUnlockModal');
  if (modal) modal.style.display = 'none';
}

function unlockProMode() {
  closeUnlockModal();
  applyDebugMode('pro');
  saveDebugMode('pro');
}

// System + Backend status
function startSystemIntervals() {
  stopAllIntervals();
  loadSystemStatus();
  loadBackendStatus();
  state.intervals.system = setInterval(loadSystemStatus, 5000);
  state.intervals.backend = setInterval(loadBackendStatus, 5000);
}

async function loadSystemStatus() {
  try {
    const res = await fetch('/api/system/status');
    if (!res.ok) return;
    const data = await res.json();
    state.lastSystemStatus = data;
    renderSystemStatus(data);
  } catch (err) {
    if (DEBUG_VERBOSE) console.debug('system status failed', err);
  }
}

function renderSystemStatus(data) {
  const system = data || {};
  setText('sys_app_name', system?.app?.name || 'FilamentHub');
  setText('sys_app_version', system?.app?.version || 'n/a');
  setText('sys_app_env', system?.app?.environment || 'n/a');
  setText('sys_app_uptime', system?.app?.uptime || '0');

  setText('sys_cpu_usage', formatPercent(system?.system?.cpu_percent));
  setText('sys_cpu_cores', system?.system?.cpu_count ? `${system.system.cpu_count} Cores` : 'n/a');
  setText('sys_ram_usage', formatPercent(system?.system?.ram_percent));
  const ramDetail = system?.system?.ram_used_gb !== undefined && system?.system?.ram_total_gb !== undefined
    ? `${system.system.ram_used_gb} GB / ${system.system.ram_total_gb} GB`
    : 'n/a';
  setText('sys_ram_detail', ramDetail);
  setText('sys_disk_usage', formatPercent(system?.system?.disk_percent));
  const diskDetail = system?.system?.disk_used_gb !== undefined && system?.system?.disk_total_gb !== undefined
    ? `${system.system.disk_used_gb} GB / ${system.system.disk_total_gb} GB`
    : 'n/a';
  setText('sys_disk_detail', diskDetail);

  setText('sys_printer_total', system?.printers?.total ?? '0');
  setText('sys_printer_online', system?.printers?.online ?? '0');
  setText('sys_ams_count', system?.ams?.count ?? '0');
  setText('sys_ams_last_update', system?.ams?.last_update || '-');
}

async function loadBackendStatus() {
  try {
    const res = await fetch('/api/debug/system_status');
    if (!res.ok) return;
    const data = await res.json();
    state.lastBackendStatus = data;
    const apiState = (data?.api?.state || 'offline');
    const dbState = (data?.db?.state || 'offline');
    const mqttState = (data?.mqtt?.state || 'offline');
    const wsState = (data?.websocket?.state || 'offline');
    const wsClients = data?.websocket?.clients || 0;
    const runtimeState = data?.runtime?.state || 'idle';
    const reqPerMin = data?.runtime?.requests_per_minute;
    const avgResp = data?.runtime?.avg_response_ms;

    applyStatus($('#apiStatus'), apiState);
    applyStatus($('#dbStatus'), dbState);
    applyStatus($('#mqttStatus'), mqttState);
    applyStatus($('#wsStatus'), wsState);
    setText('wsClients', wsClients ? `(${wsClients} clients)` : '');

    const idle = runtimeState === 'idle';
    const reqNum = Number(reqPerMin);
    const respNum = Number(avgResp);
    setText('sys_runtime_rpm', idle || !Number.isFinite(reqNum) ? '-' : reqNum);
    setText('sys_runtime_avg', idle || !Number.isFinite(respNum) ? '-' : `${respNum} ms`);
    const badge = $('#sys_runtime_state');
    if (badge) {
      badge.textContent = idle ? 'Idle' : 'Active';
      setStatusClass(badge, idle ? 'status-idle' : 'status-ok');
    }

    updateHealthScore(apiState, dbState, wsState, runtimeState);
  } catch (err) {
    if (DEBUG_VERBOSE) console.debug('backend status failed', err);
  }
}

function updateHealthScore(apiState, dbState, wsState, runtimeState) {
  const badge = $('#healthStatusBadge');
  const text = $('#healthStatusText');
  if (!badge || !text) return;
  const norm = v => String(v || '').toLowerCase();
  const api = norm(apiState);
  const db = norm(dbState);
  const ws = norm(wsState);
  const rt = norm(runtimeState);
  let status = 'ok';
  let reason = '';
  if (api === 'offline' || db === 'error' || ws === 'offline') {
    status = 'error';
    if (api === 'offline') reason = 'API offline';
    else if (db === 'error') reason = 'DB error';
    else reason = 'WebSocket offline';
  } else if (ws === 'idle' || db === 'warn') {
    status = 'warn';
    reason = ws === 'idle' ? 'WebSocket idle' : 'DB warn';
  } else {
    status = 'ok';
    reason = 'Alle Kernservices OK';
  }
  const cls = status === 'ok' ? 'status-ok' : status === 'warn' ? 'status-warn' : 'status-error';
  setStatusClass(badge, cls);
  setStatusClass(text, cls);
  badge.textContent = status === 'ok' ? 'OK' : status === 'warn' ? 'Warnung' : 'Fehler';
  text.textContent = `System Status: ${reason}`;
}

// Performance Lite
function startPerformancePolling() {
  if (state.intervals.perf) clearInterval(state.intervals.perf);
  if (state.lastPerf) renderPerformance(state.lastPerf, true);
  setPerfLoading(true);
  loadPerformanceLiteOnce();
  state.intervals.perf = setInterval(() => {
    if (document.visibilityState !== 'visible' || state.activeTab !== 'performance') return;
    loadPerformanceLiteOnce();
  }, 5000);
}

function setPerfLoading(on) {
  ['cpu', 'ram', 'disk', 'uptime'].forEach(k => addLoading($(`perf-lite-card-${k}`), on));
}

async function loadPerformanceLiteOnce() {
  try {
    const res = await fetch('/api/performance/panel', { cache: 'no-store' });
    if (!res.ok) {
      renderPerformance(null);
      setPerfLoading(false);
      return;
    }
    const data = await res.json();
    state.lastPerf = data;
    renderPerformance(data);
    state.perfLoaded = true;
    setPerfLoading(false);
  } catch {
    renderPerformance(null);
    setPerfLoading(false);
  }
}

function renderPerformance(data, fromCache = false) {
  const current = data?.current || {};
  const cpuP = current.cpu?.percent ?? current.cpu_percent;
  const ramP = current.ram?.percent ?? current.ram_percent;
  const diskP = current.disk?.percent ?? current.disk_percent;
  const ramUsed = current.ram?.used_mb ?? current.ram_used_mb;
  const ramTotal = current.ram?.total_mb ?? current.ram_total_mb;
  const diskUsed = current.disk?.used_gb ?? current.disk_used_gb;
  const diskTotal = current.disk?.total_gb ?? current.disk_total_gb;
  const uptime = current.uptime_seconds ?? current.backend_uptime ?? current.uptime;

  const cpuCard = $('#perf-lite-card-cpu');
  const ramCard = $('#perf-lite-card-ram');
  const diskCard = $('#perf-lite-card-disk');
  const upCard = $('#perf-lite-card-uptime');
  applyPerfCard(cpuCard, $('#perf-lite-cpu-value'), $('#perf-lite-cpu-meta'), cpuP, { warn: 60, error: 80 });
  applyPerfCard(ramCard, $('#perf-lite-ram-value'), $('#perf-lite-ram-meta'), ramP, { warn: 70, error: 85 }, ramUsed, ramTotal, 'MB');
  applyPerfCard(diskCard, $('#perf-lite-disk-value'), $('#perf-lite-disk-meta'), diskP, { warn: 80, error: 90 }, diskUsed, diskTotal, 'GB');
  if (upCard) setStatusClass(upCard, data ? 'status-ok' : 'status-idle');
  setText('perf-lite-uptime-value', data ? formatUptime(uptime) : '-');
  setText('perf-lite-uptime-meta', data ? 'Backend Uptime' : '-');
  addLoading(upCard, !state.perfLoaded && !fromCache);
}

function applyPerfCard(card, valueEl, metaEl, value, thresholds, used = null, total = null, unit = '') {
  if (!card) return;
  const cls = dataStatus(value, thresholds);
  setStatusClass(card, cls);
  if (valueEl) valueEl.textContent = formatPercent(value);
  let meta = '-';
  if (used !== null && total !== null && used !== undefined && total !== undefined) {
    meta = `${used} ${unit} / ${total} ${unit}`;
  }
  if (metaEl) metaEl.textContent = meta;
  addLoading(card, !state.perfLoaded);
}

function dataStatus(val, thresholds) {
  const num = Number(val);
  if (!Number.isFinite(num)) return 'status-idle';
  if (num > thresholds.error) return 'status-error';
  if (num >= thresholds.warn) return 'status-warn';
  return 'status-ok';
}

// Network info
function startNetworkInterval() {
  if (state.intervals.network) clearInterval(state.intervals.network);
  loadNetworkInfo();
  state.intervals.network = setInterval(loadNetworkInfo, 60000);
}

async function loadNetworkInfo() {
  const hasElems = $('#netLocalIp') || $('#netLocalIpSys');
  if (!hasElems) return;
  try {
    const res = await fetch('/api/debug/network');
    if (!res.ok) throw new Error('net resp');
    const data = await res.json();
    const ip = data.local_ip || '-';
    const host = data.hostname || '-';
    const range = data.suggested_range || '-';
    ['netLocalIp','netHostname','netSuggestedRange','netLocalIpSys','netHostnameSys','netSuggestedRangeSys'].forEach(id => setText(id, id.includes('Ip') ? ip : id.includes('Hostname') ? host : range));
  } catch (err) {
    if (DEBUG_VERBOSE) console.debug('network info failed', err);
    ['netLocalIp','netHostname','netSuggestedRange','netLocalIpSys','netHostnameSys','netSuggestedRangeSys'].forEach(id => setText(id, '-', '-'));
  }
}

// Scanner (Lite)
function initScanner() {
  const btn = $('#btnQuickScan');
  if (btn) btn.addEventListener('click', handleQuickScan);
}

async function handleQuickScan() {
  const btn = $('#btnQuickScan');
  if (btn) {
    btn.disabled = true;
    btn.textContent = 'Scanning...';
  }
  try {
    const res = await fetch('/api/scanner/scan/quick', { method: 'POST' });
    const data = await res.json();
    renderPrinters(Array.isArray(data?.printers) ? data.printers : []);
  } catch (err) {
    if (DEBUG_VERBOSE) console.debug('quick scan failed', err);
    renderPrinters([]);
  } finally {
    if (btn) {
      btn.disabled = false;
      btn.textContent = 'Quick Scan (LAN)';
    }
  }
}

function renderPrinters(list) {
  const container = $('#foundPrinters');
  if (!container) return;
  if (!list.length) {
    container.innerHTML = '<div class="scanner-empty">Noch kein Scan durchgefuehrt</div>';
    return;
  }
  container.innerHTML = '';
  list.forEach(printer => {
    const ip = printer.ip || '-';
    const type = (printer.type || 'generic').toLowerCase();
    const status = (printer.status || 'idle').toLowerCase();
    const icon = type === 'bambu' ? '&#128226;' : type === 'klipper' ? '&#9881;' : '&#128424;';
    const badgeCls = status === 'reachable' ? 'status-ok' : status === 'offline' ? 'status-offline' : 'status-idle';
    const div = document.createElement('div');
    div.className = 'scanner-card';
    div.innerHTML = `
      <div class="scanner-icon">${icon}</div>
      <div class="scanner-meta">
        <div class="scanner-ip">IP: ${ip}</div>
        <div>Typ: ${type}</div>
      </div>
      <div class="scanner-badge ${badgeCls}">${status}</div>
    `;
    container.appendChild(div);
  });
}

// Log viewer (Lite)
function initLogViewer() {
  const btn = $('#logRefreshBtn');
  if (btn) btn.addEventListener('click', refreshLogs);
  const select = $('#logLevelFilter');
  const search = $('#logSearchInput');
  if (select) select.addEventListener('change', refreshLogs);
  if (search) search.addEventListener('input', refreshLogs);
}

function startLogAutoRefresh() {
  if (state.intervals.logs) clearInterval(state.intervals.logs);
  refreshLogs();
  state.intervals.logs = setInterval(() => {
    if (document.visibilityState !== 'visible' || state.activeTab !== 'logs') return;
    refreshLogs();
  }, 8000);
}

async function refreshLogs() {
  const listEl = $('#logList');
  if (!listEl) return;
  const levelSel = $('#logLevelFilter');
  const search = $('#logSearchInput');
  const level = levelSel ? levelSel.value : 'all';
  const query = level && level !== 'all' ? `?limit=200&level=${encodeURIComponent(level)}` : '?limit=200';
  let logs = [];
  try {
    const res = await fetch(`/api/debug/logs${query}`);
    const data = await res.json();
    logs = Array.isArray(data?.logs) ? data.logs : [];
  } catch (err) {
    if (DEBUG_VERBOSE) console.debug('logs failed', err);
  }
  const searchVal = (search?.value || '').toLowerCase();
  if (searchVal) {
    logs = logs.filter(l => (l.message || '').toLowerCase().includes(searchVal));
  }
  renderLogs(logs);
}

function renderLogs(logs) {
  const listEl = $('#logList');
  if (!listEl) return;
  if (!logs.length) {
    listEl.innerHTML = '<div class="log-empty">Keine Logs vorhanden</div>';
    return;
  }
  listEl.innerHTML = '';
  logs.forEach(log => {
    const div = document.createElement('div');
    const lvl = (log.level || 'info').toLowerCase();
    const cls = lvl === 'error' ? 'log-level-error' : lvl === 'warning' ? 'log-level-warning' : 'log-level-info';
    div.className = 'log-entry';
    div.innerHTML = `
      <div class="ts">${log.ts || ''}</div>
      <div class="lvl ${cls}">${lvl}</div>
      <div class="msg">${log.message || ''}</div>
    `;
    listEl.appendChild(div);
  });
}
