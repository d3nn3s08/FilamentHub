// Debug Center baseline (System + Performance)
const POLL_MS = 5000;
let systemInterval = null;
let backendInterval = null;

function $(id) {
  return document.getElementById(id);
}

function setText(id, value) {
  const el = $(id);
  if (!el) return;
  el.textContent = value;
}

function setStatus(id, state) {
  const el = $(id);
  if (!el) return;
  const val = state || 'offline';
  el.textContent = val;
  el.classList.remove('status-ok', 'status-warn', 'status-error', 'status-idle', 'status-info');
  if (val === 'online' || val === 'connected' || val === 'listening') {
    el.classList.add('status-ok');
  } else if (val === 'disabled') {
    el.classList.add('status-idle');
  } else {
    el.classList.add('status-error');
  }
}

function initTabs() {
  document.querySelectorAll('.debug-tab').forEach(tab => {
    tab.addEventListener('click', () => {
      const target = tab.dataset.tab;
      document.querySelectorAll('.debug-panel').forEach(panel => {
        panel.style.display = panel.id === 'panel-' + target ? '' : 'none';
      });
      document.querySelectorAll('.debug-tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
    });
  });
}

async function loadSystemStatus() {
  try {
    const res = await fetch('/api/system/status');
    if (!res.ok) return;
    const data = await res.json();
    setText('sys_app_name', data?.app?.name || 'FilamentHub');
    setText('sys_app_version', data?.app?.version || '0.0.0');
    setText('sys_app_env', data?.app?.environment || 'development');
    setText('sys_app_uptime', data?.app?.uptime || '0');

    setText('sys_cpu_usage', data?.system?.cpu_percent !== undefined ? data.system.cpu_percent + ' %' : '-');
    setText('sys_cpu_cores', data?.system?.cpu_count !== undefined ? data.system.cpu_count + ' Cores' : 'n/a');
    setText('sys_ram_usage', data?.system?.ram_percent !== undefined ? data.system.ram_percent + ' %' : '-');
    if (data?.system?.ram_used_gb !== undefined && data?.system?.ram_total_gb !== undefined) {
      setText('sys_ram_detail', `${data.system.ram_used_gb} GB / ${data.system.ram_total_gb} GB`);
    } else {
      setText('sys_ram_detail', '-');
    }
    setText('sys_disk_usage', data?.system?.disk_percent !== undefined ? data.system.disk_percent + ' %' : '-');
    if (data?.system?.disk_used_gb !== undefined && data?.system?.disk_total_gb !== undefined) {
      setText('sys_disk_detail', `${data.system.disk_used_gb} GB / ${data.system.disk_total_gb} GB`);
    } else {
      setText('sys_disk_detail', '-');
    }
  } catch (err) {
    // ignore
  }
}

async function loadBackendStatus() {
  try {
    const res = await fetch('/api/debug/system_status');
    if (!res.ok) return;
    const data = await res.json();
    setStatus('apiStatus', data?.api?.state || 'offline');
    setStatus('dbStatus', data?.db?.state || 'offline');
    setStatus('mqttStatus', data?.mqtt?.state || 'offline');
    setStatus('wsStatus', data?.websocket?.state || 'offline');
    const clients = data?.websocket?.clients || 0;
    setText('wsClients', clients ? `(${clients} clients)` : '');
    renderSystemHealth({
      api: data?.api?.state,
      db: data?.db?.state,
      mqtt: data?.mqtt?.state,
      ws: data?.websocket?.state,
    });

    const runtimeState = data?.runtime?.state || 'idle';
    const req = Number(data?.runtime?.requests_per_minute);
    const avg = Number(data?.runtime?.avg_response_ms);
    const badge = $('#sys_runtime_state');
    if (badge) {
      badge.textContent = runtimeState === 'active' ? 'Active' : 'Idle';
      badge.classList.remove('status-ok', 'status-warn', 'status-error', 'status-idle');
      badge.classList.add(runtimeState === 'active' ? 'status-ok' : 'status-idle');
    }
    setText('sys_runtime_rpm', Number.isFinite(req) ? req.toString() : '-');
    setText('sys_runtime_avg', Number.isFinite(avg) ? `${avg} ms` : '-');
  } catch (err) {
    // ignore
  }
}

function renderSystemHealth(statusData) {
  const badge = $('#healthBadge');
  const text = $('#healthText');
  if (!badge || !text) return;
  const applyClass = (el, level) => {
    el.classList.remove('status-ok', 'status-warn', 'status-error', 'status-idle');
    if (level === 'ok') el.classList.add('status-ok');
    else if (level === 'critical') el.classList.add('status-error');
    else el.classList.add('status-warn');
  };
  // ensure text has no status classes
  text.classList.remove('status-ok', 'status-warn', 'status-error', 'status-idle');
  const api = (statusData?.api || '').toLowerCase();
  const db = (statusData?.db || '').toLowerCase();
  const ws = (statusData?.ws || '').toLowerCase();
  const mqtt = (statusData?.mqtt || '').toLowerCase();

  let level = 'warning';
  if (api === 'offline' || db === 'offline') {
    level = 'critical';
  } else if (api === 'online' && db === 'connected' && ws !== 'offline') {
    level = 'ok';
  } else {
    level = 'warning';
  }
  const textMap = {
    ok: 'All core services operational',
    warning: 'Some services require attention',
    critical: 'Critical system services unavailable',
  };
  applyClass(badge, level);
  badge.textContent = level === 'ok' ? 'OK' : level === 'critical' ? 'Critical' : 'Warning';
  text.textContent = textMap[level] || textMap.warning;
}

function startPolling() {
  loadSystemStatus();
  loadBackendStatus();
  if (systemInterval) clearInterval(systemInterval);
  if (backendInterval) clearInterval(backendInterval);
  systemInterval = setInterval(loadSystemStatus, POLL_MS);
  backendInterval = setInterval(loadBackendStatus, POLL_MS);
}

document.addEventListener('DOMContentLoaded', () => {
  initTabs();
  startPolling();
});
