<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FilamentHub Debug Center</title>
    <link rel="stylesheet" href="/static/debug.css">
</head>
<body>
    <div class="container">
        <!-- HEADER -->
        <header class="header">
            <h1> FilamentHub Debug Center</h1>
            <div class="server-status">
                <span class="status-dot" id="serverStatus"></span>
                <span id="serverUptime">--:--:--</span>
            </div>
        </header>

        <!-- TAB NAVIGATION -->
        <nav class="tabs">
            <button class="tab active" data-tab="system"> System Status</button>
            <button class="tab" data-tab="performance"> Performance</button>
            <button class="tab" data-tab="config"> Config Manager</button>
            <button class="tab" data-tab="services"> Services</button>
            <button class="tab" data-tab="scanner"> Printer Scanner</button>
            <button class="tab" data-tab="mqtt"> MQTT Viewer</button>
            <button class="tab" data-tab="logs"> Log Viewer</button>
            <button class="tab" data-tab="database"> Database</button>

        </nav>

        <!-- TAB: SYSTEM STATUS -->
        <div class="tab-content active" id="tab-system">
            <div class="grid">
                <!-- APP INFO -->
                <div class="card">
                    <h3> Application</h3>
                    <div class="info-group">
                        <div class="info-item">
                            <span class="label">Name:</span>
                            <span class="value" id="appName">-</span>
                        </div>
                        <div class="info-item">
                            <span class="label">Version:</span>
                            <span class="value" id="appVersion">-</span>
                        </div>
                        <div class="info-item">
                            <span class="label">Environment:</span>
                            <span class="value" id="appEnv">-</span>
                        </div>
                        <div class="info-item">
                            <span class="label">Uptime:</span>
                            <span class="value" id="appUptime">-</span>
                        </div>
                    </div>
                </div>

                <!-- SYSTEM RESOURCES -->
                <div class="card">
                    <h3> System Resources</h3>
                    <div class="resource-item">
                        <div class="resource-header">
                            <span>CPU</span>
                            <span id="cpuPercent">0%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="cpuBar"></div>
                        </div>
                        <small id="cpuCores">-</small>
                    </div>
                    <div class="resource-item">
                        <div class="resource-header">
                            <span>RAM</span>
                            <span id="ramPercent">0%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="ramBar"></div>
                        </div>
                        <small id="ramDetails">-</small>
                    </div>
                    <div class="resource-item">
                        <div class="resource-header">
                            <span>Disk</span>
                            <span id="diskPercent">0%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="diskBar"></div>
                        </div>
                        <small id="diskDetails">-</small>
                    </div>
                </div>

                <!-- PRINTER STATUS -->
                <div class="card">
                    <h3> 3D Drucker Modus</h3>
                    <div class="info-group">
                        <div class="info-item">
                            <span class="label">Mode:</span>
                            <span class="value badge" id="printerMode">-</span>
                        </div>
                        <div class="info-item" style="display:flex; gap:8px; align-items:center;">
                            <select id="modeSelect" class="select-input" style="flex:1;">
                                <option value="bambu">Bambu</option>
                                <option value="klipper">Klipper</option>
                                <option value="dual">Dual</option>
                                <option value="standalone">Standalone</option>
                            </select>
                            <button id="modeUpdateBtn" class="btn btn-primary btn-small">Set</button>
                        </div>
                        <div class="info-item">
                            <span class="label">Bambu:</span>
                            <span class="value" id="bambuStatus">offline</span>
                        </div>
                        <div class="info-item">
                            <span class="label">Bambu aktiviert:</span>
                            <span class="value" id="bambuConfigured">0</span>
                        </div>
                        <div class="info-item">
                            <span class="label">Klipper:</span>
                            <span class="value" id="klipperStatus">offline</span>
                        </div>
                        <div class="info-item">
                            <span class="label">Klipper aktiviert:</span>
                            <span class="value" id="klipperConfigured">0</span>
                        </div>
                    </div>
                </div>

                <!-- PYTHON ENVIRONMENT -->
                <div class="card">
                    <h3> Python Environment</h3>
                    <div class="info-group" id="pythonInfo">
                        <div class="loader">Laedt...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: PERFORMANCE MONITORING -->
        <div class="tab-content" id="tab-performance">
            <!-- ROW 1: LIVE METRICS -->
            <div class="grid grid-4col">
                <div class="card">
                    <h3> CPU Usage</h3>
                    <div class="metric-display">
                        <div class="metric-value" id="perfCpuValue">0%</div>
                        <canvas id="cpuChart" width="300" height="150"></canvas>
                    </div>
                </div>
                
                <div class="card">
                    <h3> RAM Usage</h3>
                    <div class="metric-display">
                        <div class="metric-value" id="perfRamValue">0%</div>
                        <canvas id="ramChart" width="300" height="150"></canvas>
                    </div>
                </div>
                
                <div class="card">
                    <h3> Disk Usage</h3>
                    <div class="metric-display">
                        <div class="metric-value" id="perfDiskValue">0%</div>
                        <canvas id="diskChart" width="300" height="150"></canvas>
                    </div>
                </div>
            </div>

            <!-- ROW 2: STATISTICS -->
            <div class="grid grid-2col">
                <div class="card">
                    <h3> Statistics (Last Hour)</h3>
                    <div class="info-group">
                        <div class="info-item">
                            <span class="label">Avg CPU:</span>
                            <span class="value" id="statAvgCpu">-</span>
                        </div>
                        <div class="info-item">
                            <span class="label">Max CPU:</span>
                            <span class="value" id="statMaxCpu">-</span>
                        </div>
                        <div class="info-item">
                            <span class="label">Avg RAM:</span>
                            <span class="value" id="statAvgRam">-</span>
                        </div>
                        <div class="info-item">
                            <span class="label">Max RAM:</span>
                            <span class="value" id="statMaxRam">-</span>
                        </div>
                        <div class="info-item">
                            <span class="label">Data Points:</span>
                            <span class="value" id="statDataPoints">0</span>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3> Actions</h3>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <label style="display: flex; align-items: center; gap: 10px; color: var(--text-dim);">
                            <input type="checkbox" id="perfAutoRefresh" checked style="width: 18px; height: 18px;">
                            <span>Auto-Refresh (5s interval)</span>
                        </label>
                        <button id="perfClearHistory" class="btn btn-danger">
                             Clear History
                        </button>
                        <button id="perfExportData" class="btn btn-secondary">
                             Export Data (JSON)
                        </button>
                        <div class="info-item" style="margin-top: 10px;">
                            <span class="label">Recording Since:</span>
                            <span class="value" id="perfRecordingStart">-</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ROW 3: ALERTS -->
            <div class="grid">
                <div class="card full-width">
                    <h3> Performance Alerts</h3>
                    <div id="perfAlerts" style="max-height: 200px; overflow-y: auto;">
                        <p style="color: var(--text-dim); text-align: center; padding: 20px;">
                            Keine Alerts
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: CONFIG MANAGER -->
        <div class="tab-content" id="tab-config">
            <div class="config-layout">
                <!-- LEFT: LOGGING MODULES -->
                <div class="card config-left">
                    <h3> Logging Modules</h3>
                    <div class="info-item">
                        <span class="label">Global Level:</span>
                        <select id="logLevelSelect" class="select-input">
                            <option value="DEBUG">DEBUG</option>
                            <option value="INFO">INFO</option>
                            <option value="WARNING">WARNING</option>
                            <option value="ERROR">ERROR</option>
                        </select>
                        <button id="updateLogLevel" class="btn btn-primary btn-small">Update</button>
                    </div>
                    <hr>
                    <div id="moduleToggles"></div>
                    <div class="config-info">
                        <small> Aenderungen werden sofort gespeichert</small>
                    </div>
                </div>

                <!-- RIGHT: CONFIG EDITOR -->
                <div class="card config-right">
                    <div class="config-header">
                        <h3> Configuration Editor</h3>
                        <button id="saveConfig" class="btn btn-success" disabled>
                             Speichern
                        </button>
                    </div>
                    <textarea id="configEditor" class="config-editor" spellcheck="false">Laedt...</textarea>
                    <div class="config-actions">
                        <button id="reloadConfig" class="btn btn-secondary"> Neu laden</button>
                        <button id="formatConfig" class="btn btn-secondary"> Formatieren</button>
                        <span id="configStatus" class="config-status"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: SERVICES -->
        <div class="tab-content" id="tab-services">
            <!-- ROW 1: PROCESS INFO -->
            <div class="grid grid-2col">
                <div class="card">
                    <h3> Process Info</h3>
                    <div class="info-group" id="processInfo">
                        <div class="loader">Laedt...</div>
                    </div>
                    <button id="refreshProcess" class="btn btn-secondary btn-small"> Aktualisieren</button>
                </div>
                
                <div class="card">
                    <h3> Server Stats</h3>
                    <div class="info-group" id="serverStats">
                        <div class="loader">Laedt...</div>
                    </div>
                </div>
            </div>

            <!-- ROW 2: SERVER CONTROL, DOCKER, TESTS -->
            <div class="grid grid-3col">
                <!-- SERVER CONTROL -->
                <div class="card">
                    <h3> Server Control</h3>
                    <div class="service-buttons">
                        <button id="serverRestart" class="btn btn-primary btn-block">
                             Restart
                        </button>
                        <p class="service-note">
                             Reload=True erforderlich
                        </p>
                        <div id="restartCountdown" style="display: none; margin-top: 15px; padding: 12px; background: rgba(79, 195, 247, 0.1); border-radius: 6px; text-align: center;">
                            <div style="font-size: 0.9rem; color: #4fc3f7; margin-bottom: 5px;">Server wird neugestartet...</div>
                            <div style="font-size: 1.5rem; font-weight: bold; color: #4fc3f7;">
                                <span id="countdownTimer">15</span>s
                            </div>
                            <div style="margin-top: 8px; height: 4px; background: rgba(79, 195, 247, 0.2); border-radius: 2px; overflow: hidden;">
                                <div id="countdownBar" style="height: 100%; width: 100%; background: #4fc3f7; transition: width 0.1s linear;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- DOCKER -->
                <div class="card">
                    <h3> Docker</h3>
                    <div id="dockerStatus" class="info-group docker-status-compact">
                        <div class="loader">Laedt...</div>
                    </div>
                    <div class="service-buttons">
                        <button id="dockerUp" class="btn btn-success btn-block">
                             Up
                        </button>
                        <button id="dockerDown" class="btn btn-secondary btn-block">
                             Down
                        </button>
                        <button id="dockerPs" class="btn btn-secondary btn-block">
                             Status
                        </button>
                    </div>
                    <div id="dockerOutput" class="output-box output-box-compact"></div>
                </div>

                <!-- TESTS -->
                <div class="card">
                    <h3> Tests</h3>
                    <div class="service-buttons">
                        <button id="runTestsSmoke" class="btn btn-secondary btn-block"> Smoke CRUD</button>
                        <button id="runTestsDb" class="btn btn-secondary btn-block"> DB CRUD</button>
                        <button id="runTestsAll" class="btn btn-secondary btn-block"> Alle Tests</button>
                        <button id="runCoverage" class="btn btn-secondary btn-block"> Coverage</button>
                    </div>
                    <div id="testsOutput" class="output-box output-box-compact"></div>
                </div>
            </div>

            <!-- ROW 3: DEPENDENCIES -->
            <div class="grid">
                <div class="card full-width">
                    <h3> Dependencies Management</h3>
                    <div class="service-buttons">
                        <button id="installDeps" class="btn btn-primary">
                             Install (requirements.txt)
                        </button>
                        <button id="updateAllPackages" class="btn btn-success">
                             Update All Packages
                        </button>
                        <button id="listDeps" class="btn btn-secondary">
                             Liste Packages
                        </button>
                        <button id="listOutdated" class="btn btn-warning">
                             Outdated Packages
                        </button>
                    </div>
                    <div id="depsOutput" class="output-box"></div>
                </div>
            </div>

            <!-- ROW 4: LOGS MANAGEMENT -->
            <div class="grid">
                <div class="card full-width">
                    <h3> Log Management</h3>
                    <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap; margin-bottom: 12px;">
                        <div>
                            <div style="font-weight: 600;">Backup (DB + Logs)</div>
                            <div class="service-note" style="margin: 0;">Erstellt ein ZIP in data/backups</div>
                        </div>
                        <button id="backupAll" class="btn btn-success btn-small">
                             Backup erstellen
                        </button>
                    </div>
                    <div id="backupAllOutput" class="output-box output-box-compact"></div>
                    <div style="display: flex; gap: 20px; align-items: center; margin-bottom: 18px;">
                        <label style="color: var(--text-dim); font-size: 0.95rem;">Max. Loggre (MB):
                            <input type="number" id="logMaxSize" min="1" max="100" value="10" style="width: 70px; margin-left: 8px;">
                        </label>
                        <label style="color: var(--text-dim); font-size: 0.95rem;">Backup-Anzahl:
                            <input type="number" id="logBackupCount" min="1" max="10" value="3" style="width: 50px; margin-left: 8px;">
                        </label>
                        <button id="updateLogRotation" class="btn btn-primary btn-small">bernehmen</button>
                    </div>
                    <div id="logsList"></div>
                </div>
            </div>
        </div>

        <!-- TAB: PRINTER SCANNER -->
        <div class="tab-content" id="tab-scanner">
            <!-- ROW 1: NETWORK INFO & QUICK ACTIONS -->
            <div class="grid grid-2col">
                <div class="card">
                    <h3> Network Info</h3>
                    <div class="info-group">
                        <div class="info-item">
                            <span class="label">Local IP:</span>
                            <span class="value" id="localIP">-</span>
                        </div>
                        <div class="info-item">
                            <span class="label">Hostname:</span>
                            <span class="value" id="localHostname">-</span>
                        </div>
                        <div class="info-item">
                            <span class="label">Suggested Range:</span>
                            <span class="value" id="suggestedRange">-</span>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <h3> Quick Scan</h3>
                    <p class="service-note">Scannt hufige IP-Bereiche schnell</p>
                    <div class="service-buttons">
                        <button id="quickScan" class="btn btn-primary btn-block">
                             Quick Scan
                        </button>
                        <button id="scanBambu" class="btn btn-success btn-block">
                             Bambu Only
                        </button>
                        <button id="scanKlipper" class="btn btn-success btn-block">
                             Klipper Only
                        </button>
                    </div>
                </div>
            </div>

            <!-- ROW 2: CUSTOM SCAN -->
            <div class="grid">
                <div class="card full-width">
                    <h3> Custom Network Scan</h3>
                    <div style="display: flex; gap: 10px; align-items: end; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 200px;">
                            <label style="display: block; margin-bottom: 5px; color: var(--text-dim); font-size: 0.85rem;">IP Range (CIDR)</label>
                            <input type="text" id="ipRange" class="select-input" value="192.168.1.0/24" style="width: 100%;">
                        </div>
                        <div style="min-width: 120px;">
                            <label style="display: block; margin-bottom: 5px; color: var(--text-dim); font-size: 0.85rem;">Timeout (s)</label>
                            <input type="number" id="scanTimeout" class="select-input" value="0.5" step="0.1" min="0.1" max="5" style="width: 100%;">
                        </div>
                        <button id="customScan" class="btn btn-primary">
                             Scan starten
                        </button>
                    </div>
                    <div id="scanProgress" class="scan-progress"></div>
                    <div id="scanResults" class="scan-results"></div>
                </div>
            </div>

            <!-- ROW 3: CONNECTION TESTER -->
            <div class="grid">
                <div class="card full-width">
                    <h3> Connection Tester</h3>
                    <div style="display: flex; gap: 10px; align-items: end; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 150px;">
                            <label style="display: block; margin-bottom: 5px; color: var(--text-dim); font-size: 0.85rem;">IP Address</label>
                            <input type="text" id="testIp" class="select-input" placeholder="192.168.1.100" style="width: 100%;">
                        </div>
                        <div style="min-width: 120px;">
                            <label style="display: block; margin-bottom: 5px; color: var(--text-dim); font-size: 0.85rem;">Port</label>
                            <select id="testPort" class="select-input" style="width: 100%;">
                                <option value="6000">6000 (Bambu)</option>
                                <option value="7125">7125 (Klipper)</option>
                                <option value="80">80 (HTTP)</option>
                            </select>
                        </div>
                        <button id="testConnection" class="btn btn-primary">
                             Test
                        </button>
                    </div>
                    <div id="testResults" class="output-box output-box-compact"></div>
                </div>
            </div>

            <!-- ROW 4: FOUND PRINTERS -->
            <div class="grid">
                <div class="card full-width">
                    <h3> Gefundene Drucker</h3>
                    <div id="foundPrinters">
                        <p style="color: var(--text-dim); text-align: center; padding: 20px;">
                            Noch keine Drucker gefunden. Starte einen Scan!
                        </p>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">
                        <button id="addPrinter" class="btn btn-primary">
                             Drucker hinzufuegen
                        </button>
                    </div>
                    <p style="color: var(--text-dim); font-size: 0.85rem; margin-top: 8px; font-style: italic;">
                         Tipp: Teste jeden Drucker bevor du ihn speicherst
                    </p>
                    <div id="configOutput" class="output-box"></div>
                </div>
            </div>
        </div>

        <!-- TAB: MQTT VIEWER -->
        <div class="tab-content" id="tab-mqtt">
            <!-- ROW 1: CONNECTION MANAGER -->
            <div class="grid grid-2col">
                <div class="card">
                    <h3> MQTT Connection</h3>
                    <div id="mqttPrinterDropdown" style="margin-bottom: 12px;"></div>
                    <div class="info-group">
                        <div class="info-item">
                            <label style="display: block; margin-bottom: 5px; color: var(--text-dim); font-size: 0.85rem;">Broker Address</label>
                            <input type="text" id="mqttBroker" class="select-input" placeholder="192.168.1.100" value="localhost" style="width: 100%;">
                        </div>
                        <div class="info-item" style="display: flex; gap: 10px;">
                            <div style="flex: 1;">
                                <label style="display: block; margin-bottom: 5px; color: var(--text-dim); font-size: 0.85rem;">Port</label>
                                <select id="mqttPort" class="select-input" style="width: 100%;">
                                    <option value="1883">1883 (MQTT Standard)</option>
                                    <option value="8883">8883 (MQTT TLS/Bambu)</option>
                                    <option value="6000">6000 (Bambu)</option>
                                    <option value="7125">7125 (Klipper)</option>
                                </select>
                            </div>
                            <div style="flex: 1;">
                                <label style="display: block; margin-bottom: 5px; color: var(--text-dim); font-size: 0.85rem;">Client ID</label>
                                <input type="text" id="mqttClientId" class="select-input" value="filamenthub_debug" style="width: 100%;">
                            </div>
                        </div>
                        <div class="info-item">
                            <label style="display: block; margin-bottom: 5px; color: var(--text-dim); font-size: 0.85rem;">Username (optional)</label>
                            <input type="text" id="mqttUsername" class="select-input" placeholder="bblp" style="width: 100%;">
                        </div>
                        <div class="info-item">
                            <label style="display: block; margin-bottom: 5px; color: var(--text-dim); font-size: 0.85rem;">Password (optional)</label>
                            <div style="display:flex;align-items:center;gap:8px;">
                                <input type="password" id="mqttPassword" class="select-input" style="flex:1;">
                                <button type="button" id="mqttPasswordToggle" class="btn btn-secondary btn-sm" style="min-width:60px;">👁</button>
                            </div>
                        </div>
                    </div>
                                        <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button id="mqttConnect" class="btn btn-success">
                            Connect
                        </button>
                        <button id="mqttDisconnect" class="btn btn-danger" disabled>
                            Disconnect
                        </button>
                        <button id="mqttSubscribeDefaults" class="btn btn-secondary">
                            Bambu-Topics
                        </button>
                    </div>
                </div>

                <div class="card">
                    <h3> Connection Status</h3>
                    <div class="info-group">
                        <div class="info-item">
                            <span class="label">Status:</span>
                            <span class="value" id="mqttStatus">🟢 Online</span>
                        </div>
                        <div class="info-item">
                            <span class="label">Active Connections:</span>
                            <span class="value" id="mqttActiveConnections">0</span>
                        </div>
                        <div class="info-item">
                            <span class="label">Subscribed Topics:</span>
                            <span class="value" id="mqttSubscribedCount">0</span>
                        </div>
                        <div class="info-item">
                            <span class="label">Messages Received:</span>
                            <span class="value" id="mqttMessageCount">0</span>
                        </div>
                        <div class="info-item">
                            <span class="label">Buffer Size:</span>
                            <span class="value" id="mqttBufferSize">0</span>
                        </div>
                    </div>
                    <button id="mqttRefreshStatus" class="btn btn-secondary" style="margin-top: 15px;">
                         Refresh Status
                    </button>
                </div>
            </div>

            <!-- ROW 2: TOPIC BROWSER & SUGGESTED TOPICS -->
            <div class="grid grid-2col">
                <div class="card">
                    <h3> Topic Subscription</h3>
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <input type="text" id="mqttTopic" class="select-input" placeholder="device/+/report" style="flex: 1;">
                        <button id="mqttSubscribe" class="btn btn-primary" disabled>
                             Subscribe
                        </button>
                    </div>
                    <div id="mqttTopicList" style="max-height: 200px; overflow-y: auto;">
                        <p style="color: var(--text-dim); text-align: center; padding: 10px;">
                            No subscriptions yet
                        </p>
                    </div>
                </div>

                <div class="card">
                    <h3> Suggested Topics</h3>
                    <div style="display: flex; flex-direction: column; gap: 8px; max-height: 240px; overflow-y: auto;">
                        <button class="btn btn-secondary btn-sm topic-btn" data-topic="device/+/report">device/+/report</button>
                        <button class="btn btn-secondary btn-sm topic-btn" data-topic="device/+/print">device/+/print</button>
                        <button class="btn btn-secondary btn-sm topic-btn" data-topic="device/+/camera">device/+/camera</button>
                        <button class="btn btn-secondary btn-sm topic-btn" data-topic="device/+/ams">device/+/ams</button>
                        <button class="btn btn-secondary btn-sm topic-btn" data-topic="device/+/temperature">device/+/temperature</button>
                        <button class="btn btn-secondary btn-sm topic-btn" data-topic="#"># (All Topics)</button>
                    </div>
                </div>
            </div>

            <!-- ROW 3: MESSAGE STREAM -->
            <div class="grid grid-2col">
                <div class="card">
                    <h3> MQTT Health & Aggregation</h3>
                    
                    <!-- Health Monitor -->
                    <div style="background:#1a1a1a; border:1px solid #333; border-radius:6px; padding:12px; margin-bottom:12px;">
                        <h4 style="font-size:0.95rem; margin:0 0 10px 0; color:#6cf;">Connection Health</h4>
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px; font-size:0.85rem;">
                            <div><span style="color:#888;">Uptime:</span> <span id="mqttUptime" style="color:#ddd;">0s</span></div>
                            <div><span style="color:#888;">Messages/sec:</span> <span id="mqttMsgRate" style="color:#ddd;">0</span></div>
                            <div><span style="color:#888;">Topics aktiv:</span> <span id="mqttActiveTopics" style="color:#ddd;">0</span></div>
                            <div><span style="color:#888;">Avg Payload:</span> <span id="mqttAvgPayload" style="color:#ddd;">0 B</span></div>
                        </div>
                    </div>
                    
                    <!-- Live Values Extraction -->
                    <div style="background:#1a1a1a; border:1px solid #333; border-radius:6px; padding:12px;">
                        <h4 style="font-size:0.95rem; margin:0 0 10px 0; color:#6cf;">Live Values</h4>
                        <div id="mqttLiveValues" style="display:grid; grid-template-columns: 1fr 1fr; gap:8px; font-size:0.85rem;">
                            <div class="live-value-item">
                                <span style="color:#888;">Nozzle Temp:</span>
                                <span id="valNozzleTemp" style="color:#ff9800; font-weight:500;"></span>
                            </div>
                            <div class="live-value-item">
                                <span style="color:#888;">Bed Temp:</span>
                                <span id="valBedTemp" style="color:#ff9800; font-weight:500;"></span>
                            </div>
                            <div class="live-value-item">
                                <span style="color:#888;">Progress:</span>
                                <span id="valProgress" style="color:#66bb6a; font-weight:500;"></span>
                            </div>
                            <div class="live-value-item">
                                <span style="color:#888;">Layer:</span>
                                <span id="valLayer" style="color:#4fc3f7; font-weight:500;"></span>
                            </div>
                            <div class="live-value-item">
                                <span style="color:#888;">Speed:</span>
                                <span id="valSpeed" style="color:#ddd; font-weight:500;"></span>
                            </div>
                            <div class="live-value-item">
                                <span style="color:#888;">Status:</span>
                                <span id="valStatus" style="color:#ddd; font-weight:500;"></span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <h3> JSON Inspector</h3>
                    <div style="display:flex; gap:12px; align-items:center; margin-bottom:8px; font-size:0.9rem;">
                        <div>Topic: <span id="mqttJsonTopic" style="color: var(--accent); font-family: 'Consolas', monospace;"></span></div>
                        <div>Zeit: <span id="mqttJsonTime" style="color: var(--text-dim)"></span></div>
                        <div style="margin-left:auto; display:flex; gap:8px;">
                            <button class="btn btn-secondary btn-sm" id="jsonExpandAll"> Expand All</button>
                            <button class="btn btn-secondary btn-sm" id="jsonCollapseAll"> Collapse All</button>
                            <button class="btn btn-primary btn-sm" id="jsonCopyAll"> Copy JSON</button>
                        </div>
                    </div>
                    <div style="display:flex; align-items:center; gap:32px; margin:-4px 0 8px 0;">
                        <span id="mqttConnectionStatus" style="font-weight:bold; color:#ef5350;"> Disconnected</span>
                        <span style="color:#4fc3f7; font-size:0.95rem;">Messages Received: <span id="mqttMessagesReceived">0</span></span>
                        <span style="color:#ff9800; font-size:0.95rem;">Handler aktiv: <span id="mqttHandlersActive">0</span></span>
                    </div>
                    <div id="mqttJsonTree" class="json-tree" style="max-height: 260px; overflow-y:auto; background:#0f0f0f; border:1px solid #333; border-radius:8px; padding:10px; font-family: 'Consolas', monospace; font-size:0.85rem;">
                        <p style="color: var(--text-dim); text-align:center; padding: 8px;">Klicke ein Topic (Liste links oder Nachricht oben), um die JSON-Struktur zu sehen.</p>
                    </div>
                </div>
            </div>

            <!-- ROW 4: JOB + AMS OVERVIEW -->
            <div class="grid">
                <div class="card">
                    <h3> PrinterData</h3>
                    <div id="printerData" class="printer-wrap"></div>
                </div>
                <div class="card">
                    <h3> Raw Payload</h3>
                    <div id="rawData" class="raw-wrap"></div>
                </div>
            </div>

            <!-- ROW 5: JOB + AMS OVERVIEW -->
            <div class="grid">
                <div class="card">
                    <h3> Job Overview</h3>
                    <div style="display:flex; justify-content:space-between; align-items:center; color: var(--text-dim); font-size:0.9rem; margin-bottom:8px;">
                        <span>Letzte Nachricht: <span id="mqttJobMeta" style="color: var(--text);"></span></span>
                        <span style="font-size:0.85rem;">Quelle: device/&lt;serial&gt;/report</span>
                    </div>
                    <div id="mqttJobContainer" style="display:grid; grid-template-columns: 1fr; gap:12px;"></div>
                </div>
                <div class="card">
                    <h3> AMS Overview</h3>
                    <div style="display:flex; justify-content:space-between; align-items:center; color: var(--text-dim); font-size:0.9rem; margin-bottom:8px;">
                        <span>Letzte Nachricht: <span id="mqttAmsMeta" style="color: var(--text);"></span></span>
                        <span style="font-size:0.85rem;">Quelle: device/&lt;serial&gt;/report</span>
                    </div>
                    <div id="mqttAmsContainer" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap:12px;"></div>
                </div>
            </div>

            <!-- ROW 4: MESSAGE PUBLISH -->
            <div class="grid">
                <div class="card full-width">
                    <h3> Publish Message</h3>
                    <div style="display: flex; gap: 10px; margin-bottom: 10px; align-items: end;">
                        <div style="flex: 2;">
                            <label style="display: block; margin-bottom: 5px; color: var(--text-dim); font-size: 0.85rem;">Topic</label>
                            <input type="text" id="mqttPublishTopic" class="select-input" placeholder="device/12345/request" style="width: 100%;">
                        </div>
                        <div style="min-width: 100px;">
                            <label style="display: block; margin-bottom: 5px; color: var(--text-dim); font-size: 0.85rem;">QoS</label>
                            <select id="mqttPublishQos" class="select-input" style="width: 100%;">
                                <option value="0">0</option>
                                <option value="1">1</option>
                                <option value="2">2</option>
                            </select>
                        </div>
                    </div>
                    <textarea id="mqttPublishPayload" class="select-input" placeholder='{"command": "start_print"}' 
                              style="width: 100%; min-height: 100px; font-family: 'Consolas', monospace; resize: vertical;"></textarea>
                    <button id="mqttPublish" class="btn btn-primary" style="margin-top: 10px;" disabled>
                         Publish
                    </button>
                </div>
            </div>

            <!-- ROW 5: LIVE RAW OUTPUT (BELOW PUBLISH) -->
            <div class="grid">
                <div class="card full-width">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <h3> Live Raw Output</h3>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="text" id="rawOutputSearch" placeholder=" Suche..." style="padding: 6px 12px; border: 1px solid #444; background: #2a2a2a; color: #fff; border-radius: 4px; width: 200px;" oninput="filterRawOutput()">
                            <button id="liveViewOn" class="btn btn-success btn-sm" onclick="toggleLiveView(true)"> Live AN</button>
                            <button id="liveViewOff" class="btn btn-secondary btn-sm" onclick="toggleLiveView(false)"> Live AUS</button>
                            <button id="rawOutputPause" class="btn btn-secondary btn-sm" onclick="toggleRawOutputPause()"> Pause</button>
                            <button onclick="document.getElementById('mqttLiveRawPublish').scrollTop = document.getElementById('mqttLiveRawPublish').scrollHeight;" class="btn btn-secondary btn-sm"> Scroll to bottom</button>
                        </div>
                    </div>
                    <p style="color: var(--text-dim); margin-bottom: 8px;">Zeigt kompakt die zuletzt empfangenen MQTT-Daten (neueste unten).</p>
                    <div id="mqttLiveRawPublish" style="min-height: 300px; max-height: 500px; overflow-y: scroll; font-family: 'Consolas', monospace; font-size: 0.85rem; background:#000000; color:#00ff00; border:3px solid #00ff00; border-radius:8px; padding: 12px; position: relative; z-index: 1000;">
                        <p style="color: #00ff00; text-align: center; padding: 20px; font-size: 0.9rem;"> Warte auf MQTT-Daten...<br><small style="color: #888;">Stelle sicher, dass du verbunden bist und Topics abonniert hast.</small></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: LOG VIEWER -->
        <div class="tab-content" id="tab-logs">
            <div class="card">
                <h3> Log Viewer</h3>
                <p>Zum vollstndigen Log-Viewer: <a href="/logs" target="_blank">Log Dashboard ffnen</a></p>
            </div>
        </div>

        <!-- TAB: DATABASE -->
        <div class="tab-content" id="tab-database">
            <!-- ROW 1: DATABASE INFO & STATS -->
            <div class="grid grid-2col">
                <div class="card">
                    <h3> Database Info</h3>
                    <div class="info-group" id="dbInfo">
                        <div class="loader">Laedt...</div>
                    </div>
                </div>
                <div class="card">
                    <h3> Statistics</h3>
                    <div class="info-group" id="dbStats">
                        <div class="loader">Laedt...</div>
                    </div>
                </div>
            </div>


            <!-- ROW 2: TABLES -->
            <div class="grid">

            </div>

            <!-- ROW 2b: BACKUPS (ausgelagert ins Admin-Panel) -->
            <!-- entfernt -->

            <!-- ROW 3: ACTIONS -->

            <!-- ROW 4: QUERY EDITOR (Optional) -->
            <div class="grid">
                <div class="card full-width">
                    <h3> SQL Query (Developer)</h3>
                    <p class="service-note"> Nur SELECT Queries erlaubt</p>
                    <textarea id="sqlQuery" class="config-editor" style="min-height: 100px;" placeholder="SELECT * FROM material LIMIT 10"></textarea>
                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                        <button id="executeQuery" class="btn btn-primary"> Execute</button>
                        <button id="clearQuery" class="btn btn-secondary"> Clear</button>
                    </div>
                    <div id="queryOutput" class="output-box"></div>
                </div>
            </div>
        </div>



    </div>

    <!-- MODAL: Test Ergebnis -->
    <div id="testResultModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="testResultTitle"> Verbindungstest</h3>
                <button class="modal-close" onclick="closeTestResultModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="testResultContent" class="test-result-box"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeTestResultModal()">Schliessen</button>
            </div>
        </div>
    </div>

    <!-- MODAL: Drucker hinzufuegen -->
    <div id="addPrinterModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3> Drucker manuell hinzufuegen</h3>
                <button class="modal-close" onclick="closeAddPrinterModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="info-group" style="gap: 15px;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; color: var(--text-dim);">IP-Adresse *</label>
                        <input type="text" id="manualIp" class="select-input" placeholder="192.168.178.41" style="width: 100%;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; color: var(--text-dim);">Port *</label>
                        <input type="number" id="manualPort" class="select-input" placeholder="6000" value="6000" style="width: 100%;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; color: var(--text-dim);">Drucker-Typ</label>
                        <select id="manualType" class="select-input" style="width: 100%;">
                            <option value="bambu">Bambu Lab</option>
                            <option value="klipper">Klipper/Moonraker</option>
                            <option value="unknown">Unbekannt</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; color: var(--text-dim);">Hostname (optional)</label>
                        <input type="text" id="manualHostname" class="select-input" placeholder="X1C-12345" style="width: 100%;">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeAddPrinterModal()">Abbrechen</button>
                <button class="btn btn-primary" onclick="addManualPrinter()"> Hinzufuegen</button>
            </div>
        </div>
    </div>

    <script src="/static/debug.js"></script>
</body>
</html>






